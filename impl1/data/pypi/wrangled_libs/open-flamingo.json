{
  "classifiers": [
    "development status :: 4 - beta",
    "intended audience :: developers",
    "license :: osi approved :: mit license",
    "programming language :: python :: 3.9",
    "topic :: scientific/engineering :: artificial intelligence"
  ],
  "description": "# \ud83e\udda9 openflamingo\n\n[![pypi version](https://badge.fury.io/py/open_flamingo.svg)](https://badge.fury.io/py/open_flamingo)\n\n[paper](https://arxiv.org/abs/2308.01390) | blog posts: [1](https://laion.ai/blog/open-flamingo/), [2](https://laion.ai/blog/open-flamingo-v2/) | [demo](https://huggingface.co/spaces/openflamingo/openflamingo)\n\nwelcome to our open source implementation of deepmind's [flamingo](https://www.deepmind.com/blog/tackling-multiple-tasks-with-a-single-visual-language-model)! \n\nin this repository, we provide a pytorch implementation for training and evaluating openflamingo models.\nif you have any questions, please feel free to open an issue. we also welcome contributions!\n\n# table of contents\n- [installation](#installation)\n- [approach](#approach)\n  * [model architecture](#model-architecture)\n- [usage](#usage)\n  * [initializing an openflamingo model](#initializing-an-openflamingo-model)\n  * [generating text](#generating-text)\n- [training](#training)\n  * [dataset](#dataset)\n- [evaluation](#evaluation)\n- [future plans](#future-plans)\n- [team](#team)\n- [acknowledgments](#acknowledgments)\n- [citing](#citing)\n\n# installation\n\nto install the package in an existing environment, run \n```\npip install open-flamingo\n```\n\nor to create a conda environment for running openflamingo, run\n```\nconda env create -f environment.yml\n```\n\nto install training or eval dependencies, run one of the first two commands. to install everything, run the third command.\n```\npip install open-flamingo[training]\npip install open-flamingo[eval]\npip install open-flamingo[all]\n```\n\nthere are three `requirements.txt` files: \n- `requirements.txt` \n- `requirements-training.txt`\n- `requirements-eval.txt`\n\ndepending on your use case, you can install any of these with `pip install -r <requirements-file.txt>`. the base file contains only the dependencies needed for running the model.\n\n# approach\nopenflamingo is a multimodal language model that can be used for a variety of tasks. it is trained on a large multimodal dataset (e.g. multimodal c4) and can be used to generate text conditioned on interleaved images/text. for example, openflamingo can be used to generate a caption for an image, or to generate a question given an image and a text passage. the benefit of this approach is that we are able to rapidly adapt to new tasks using in-context learning.\n\n## model architecture\nopenflamingo combines a pretrained vision encoder and a language model using cross attention layers. the model architecture is shown below.\n\n![openflamingo architecture](docs/flamingo.png) \ncredit: [flamingo](https://www.deepmind.com/blog/tackling-multiple-tasks-with-a-single-visual-language-model)\n\n# usage\n## initializing an openflamingo model\nwe support pretrained vision encoders from the [openclip](https://github.com/mlfoundations/open_clip) package, which includes openai's pretrained models. \nwe also support pretrained language models from the `transformers` package, such as [mpt](https://huggingface.co/models?search=mosaicml%20mpt), [redpajama](https://huggingface.co/models?search=redpajama), [llama](https://huggingface.co/models?search=llama), [opt](https://huggingface.co/models?search=opt), [gpt-neo](https://huggingface.co/models?search=gpt-neo), [gpt-j](https://huggingface.co/models?search=gptj), and [pythia](https://huggingface.co/models?search=pythia) models.\n\n``` python\nfrom open_flamingo import create_model_and_transforms\n\nmodel, image_processor, tokenizer = create_model_and_transforms(\n    clip_vision_encoder_path=\"vit-l-14\",\n    clip_vision_encoder_pretrained=\"openai\",\n    lang_encoder_path=\"anas-awadalla/mpt-1b-redpajama-200b\",\n    tokenizer_path=\"anas-awadalla/mpt-1b-redpajama-200b\",\n    cross_attn_every_n_layers=1\n)\n```\n\n## released openflamingo models\nwe have trained the following openflamingo models so far.\n\n|# params|language model|vision encoder|xattn interval*|coco 4-shot cider|vqav2 4-shot accuracy|weights|\n|------------|--------------|--------------|----------|-----------|-------|----|\n|3b| mosaicml/mpt-1b-redpajama-200b | openai clip vit-l/14 | 1 | 77.3 | 45.8 |[link](https://huggingface.co/openflamingo/openflamingo-3b-vitl-mpt1b)|\n|3b| mosaicml/mpt-1b-redpajama-200b-dolly | openai clip vit-l/14 | 1 | 82.7 | 45.7 |[link](https://huggingface.co/openflamingo/openflamingo-3b-vitl-mpt1b-langinstruct)|\n|4b| togethercomputer/redpajama-incite-base-3b-v1 | openai clip vit-l/14 | 2 | 81.8 | 49.0 | [link](https://huggingface.co/openflamingo/openflamingo-4b-vitl-rpj3b)|\n|4b| togethercomputer/redpajama-incite-instruct-3b-v1 | openai clip vit-l/14 | 2 | 85.8 | 49.0 | [link](https://huggingface.co/openflamingo/openflamingo-4b-vitl-rpj3b-langinstruct)|\n|9b| mosaicml/mpt-7b | openai clip vit-l/14 | 4 | 89.0 | 54.8 | [link](https://huggingface.co/openflamingo/openflamingo-9b-vitl-mpt7b)|\n\n*\\* xattn interval refers to the `--cross_attn_every_n_layers` argument.*\n\nnote: as part of our v2 release, we have deprecated a previous llama-based checkpoint. however, you can continue to use our older checkpoint using the new codebase.\n\n## downloading pretrained weights\n\nto instantiate an openflamingo model with one of our released weights, initialize the model as above and use the following code.\n\n```python\n# grab model checkpoint from huggingface hub\nfrom huggingface_hub import hf_hub_download\nimport torch\n\ncheckpoint_path = hf_hub_download(\"openflamingo/openflamingo-3b-vitl-mpt1b\", \"checkpoint.pt\")\nmodel.load_state_dict(torch.load(checkpoint_path), strict=false)\n```\n\n## generating text\nbelow is an example of generating text conditioned on interleaved images/text. in particular, let's try few-shot image captioning.\n\n``` python\nfrom pil import image\nimport requests\nimport torch\n\n\"\"\"\nstep 1: load images\n\"\"\"\ndemo_image_one = image.open(\n    requests.get(\n        \"http://images.cocodataset.org/val2017/000000039769.jpg\", stream=true\n    ).raw\n)\n\ndemo_image_two = image.open(\n    requests.get(\n        \"http://images.cocodataset.org/test-stuff2017/000000028137.jpg\",\n        stream=true\n    ).raw\n)\n\nquery_image = image.open(\n    requests.get(\n        \"http://images.cocodataset.org/test-stuff2017/000000028352.jpg\", \n        stream=true\n    ).raw\n)\n\n\n\"\"\"\nstep 2: preprocessing images\ndetails: for openflamingo, we expect the image to be a torch tensor of shape \n batch_size x num_media x num_frames x channels x height x width. \n in this case batch_size = 1, num_media = 3, num_frames = 1,\n channels = 3, height = 224, width = 224.\n\"\"\"\nvision_x = [image_processor(demo_image_one).unsqueeze(0), image_processor(demo_image_two).unsqueeze(0), image_processor(query_image).unsqueeze(0)]\nvision_x = torch.cat(vision_x, dim=0)\nvision_x = vision_x.unsqueeze(1).unsqueeze(0)\n\n\"\"\"\nstep 3: preprocessing text\ndetails: in the text we expect an <image> special token to indicate where an image is.\n we also expect an <|endofchunk|> special token to indicate the end of the text \n portion associated with an image.\n\"\"\"\ntokenizer.padding_side = \"left\" # for generation padding tokens should be on the left\nlang_x = tokenizer(\n    [\"<image>an image of two cats.<|endofchunk|><image>an image of a bathroom sink.<|endofchunk|><image>an image of\"],\n    return_tensors=\"pt\",\n)\n\n\n\"\"\"\nstep 4: generate text\n\"\"\"\ngenerated_text = model.generate(\n    vision_x=vision_x,\n    lang_x=lang_x[\"input_ids\"],\n    attention_mask=lang_x[\"attention_mask\"],\n    max_new_tokens=20,\n    num_beams=3,\n)\n\nprint(\"generated text: \", tokenizer.decode(generated_text[0]))\n```\n\n# training\nwe provide training scripts in `open_flamingo/train`. we provide an example slurm script in `open_flamingo/scripts/run_train.py`, as well as the following example command:\n```\ntorchrun --nnodes=1 --nproc_per_node=4 open_flamingo/train/train.py \\\n  --lm_path anas-awadalla/mpt-1b-redpajama-200b \\\n  --tokenizer_path anas-awadalla/mpt-1b-redpajama-200b \\\n  --cross_attn_every_n_layers 1 \\\n  --dataset_resampled \\\n  --batch_size_mmc4 32 \\\n  --batch_size_laion 64 \\\n  --train_num_samples_mmc4 125000\\\n  --train_num_samples_laion 250000 \\\n  --loss_multiplier_laion 0.2 \\\n  --workers=4 \\\n  --run_name openflamingo-3b-vitl-mpt1b \\\n  --num_epochs 480 \\\n  --warmup_steps  1875 \\\n  --mmc4_textsim_threshold 0.24 \\\n  --laion_shards \"/path/to/shards/shard-{0000..0999}.tar\" \\\n  --mmc4_shards \"/path/to/shards/shard-{0000..0999}.tar\" \\\n  --report_to_wandb\n```\n\n*note: the mpt-1b [base](https://huggingface.co/mosaicml/mpt-1b-redpajama-200b)  and [instruct](https://huggingface.co/mosaicml/mpt-1b-redpajama-200b-dolly) modeling code does not accept the `labels` kwarg or compute cross-entropy loss directly within `forward()`, as expected by our codebase. we suggest using a modified version of the mpt-1b models found [here](https://huggingface.co/anas-awadalla/mpt-1b-redpajama-200b) and [here](https://huggingface.co/anas-awadalla/mpt-1b-redpajama-200b-dolly).*\n\nfor more details, see our [training readme](https://github.com/mlfoundations/open_flamingo/tree/main/open_flamingo/train).\n\n\n# evaluation\nan example evaluation script is at `open_flamingo/scripts/run_eval.sh`. please see our [evaluation readme](https://github.com/mlfoundations/open_flamingo/tree/main/open_flamingo/eval) for more details.\n\n\nto run evaluations on okvqa you will need to run the following command:\n```\nimport nltk\nnltk.download('wordnet')\n```\n\n\n# future plans\n- [ ] add support for video input\n\n# team\n\nopenflamingo is developed by:\n\n[anas awadalla*](https://anas-awadalla.streamlit.app/), [irena gao*](https://i-gao.github.io/), [joshua gardner](https://homes.cs.washington.edu/~jpgard/), [jack hessel](https://jmhessel.com/), [yusuf hanafy](https://www.linkedin.com/in/yusufhanafy/), [wanrong zhu](https://wanrong-zhu.com/), [kalyani marathe](https://sites.google.com/uw.edu/kalyanimarathe/home?authuser=0), [yonatan bitton](https://yonatanbitton.github.io/), [samir gadre](https://sagadre.github.io/), [shiori sagawa](https://cs.stanford.edu/~ssagawa/), [jenia jitsev](https://scholar.google.de/citations?user=p1fuamkaaaaj&hl=en), [simon kornblith](https://simonster.com/), [pang wei koh](https://koh.pw/), [gabriel ilharco](https://gabrielilharco.com/), [mitchell wortsman](https://mitchellnw.github.io/), [ludwig schmidt](https://people.csail.mit.edu/ludwigs/).\n\nthe team is primarily from the university of washington, stanford, ai2, ucsb, and google.\n\n# acknowledgments\nthis code is based on lucidrains' [flamingo implementation](https://github.com/lucidrains/flamingo-pytorch) and david hansmair's [flamingo-mini repo](https://github.com/dhansmair/flamingo-mini). thank you for making your code public! we also thank the [openclip](https://github.com/mlfoundations/open_clip) team as we use their data loading code and take inspiration from their library design.\n\nwe would also like to thank [jean-baptiste alayrac](https://www.jbalayrac.com) and [antoine miech](https://antoine77340.github.io) for their advice, [rohan taori](https://www.rohantaori.com/), [nicholas schiefer](https://nicholasschiefer.com/), [deep ganguli](https://hai.stanford.edu/people/deep-ganguli), [thomas liao](https://thomasliao.com/), [tatsunori hashimoto](https://thashim.github.io/), and [nicholas carlini](https://nicholas.carlini.com/) for their help with assessing the safety risks of our release, and to [stability ai](https://stability.ai) for providing us with compute resources to train these models.\n\n# citing\nif you found this repository useful, please consider citing:\n\n```\n@software{anas_awadalla_2023_7733589,\n  author = {awadalla, anas and gao, irena and gardner, joshua and hessel, jack and hanafy, yusuf and zhu, wanrong and marathe, kalyani and bitton, yonatan and gadre, samir and jitsev, jenia and kornblith, simon and koh, pang wei and ilharco, gabriel and wortsman, mitchell and schmidt, ludwig},\n  title = {openflamingo},\n  month        = mar,\n  year         = 2023,\n  publisher    = {zenodo},\n  version      = {v0.1.1},\n  doi          = {10.5281/zenodo.7733589},\n  url          = {https://doi.org/10.5281/zenodo.7733589}\n}\n```\n\n```\n@article{alayrac2022flamingoav,\n  title={flamingo: a visual language model for few-shot learning},\n  author={jean-baptiste alayrac and jeff donahue and pauline luc and antoine miech and iain barr and yana hasson and karel lenc and arthur mensch and katie millican and malcolm reynolds and roman ring and eliza rutherford and serkan cabi and tengda han and zhitao gong and sina samangooei and marianne monteiro and jacob menick and sebastian borgeaud and andy brock and aida nematzadeh and sahand sharifzadeh and mikolaj binkowski and ricardo barreira and oriol vinyals and andrew zisserman and karen simonyan},\n  journal={arxiv},\n  year={2022},\n  volume={abs/2204.14198}\n}\n```\n",
  "docs_url": null,
  "keywords": "machine learning",
  "license": "mit",
  "name": "open-flamingo",
  "package_url": "https://pypi.org/project/open-flamingo/",
  "project_url": "https://pypi.org/project/open-flamingo/",
  "project_urls": null,
  "release_url": "https://pypi.org/project/open-flamingo/2.0.1/",
  "requires_dist": [
    "einops",
    "einops-exts",
    "transformers >=4.28.1",
    "torch ==2.0.1",
    "pillow",
    "open-clip-torch >=2.16.0",
    "sentencepiece ==0.1.98",
    "webdataset ; extra == 'all'",
    "pillow ; extra == 'all'",
    "nltk ; extra == 'all'",
    "tqdm ; extra == 'all'",
    "inflection ; extra == 'all'",
    "pycocotools ; extra == 'all'",
    "einops-exts ; extra == 'all'",
    "wandb ; extra == 'all'",
    "open-clip-torch >=2.16.0 ; extra == 'all'",
    "torchvision ; extra == 'all'",
    "transformers >=4.28.1 ; extra == 'all'",
    "sentencepiece ==0.1.98 ; extra == 'all'",
    "einops ; extra == 'all'",
    "pycocoevalcap ; extra == 'all'",
    "torch ==2.0.1 ; extra == 'all'",
    "braceexpand ; extra == 'all'",
    "scipy ; extra == 'all'",
    "scipy ; extra == 'eval'",
    "torchvision ; extra == 'eval'",
    "nltk ; extra == 'eval'",
    "inflection ; extra == 'eval'",
    "pycocoevalcap ; extra == 'eval'",
    "pycocotools ; extra == 'eval'",
    "tqdm ; extra == 'eval'",
    "wandb ; extra == 'training'",
    "torchvision ; extra == 'training'",
    "braceexpand ; extra == 'training'",
    "webdataset ; extra == 'training'",
    "tqdm ; extra == 'training'"
  ],
  "requires_python": "",
  "summary": "an open-source framework for training large multimodal models",
  "version": "2.0.1",
  "releases": [],
  "developers": [],
  "kwds": "deepmind openflamingo open_flamingo pytorch openai",
  "license_kwds": "mit",
  "libtype": "pypi",
  "id": "pypi_open_flamingo",
  "homepage": "",
  "release_count": 6,
  "dependency_ids": [
    "pypi_braceexpand",
    "pypi_einops",
    "pypi_einops_exts",
    "pypi_inflection",
    "pypi_nltk",
    "pypi_open_clip_torch",
    "pypi_pillow",
    "pypi_pycocoevalcap",
    "pypi_pycocotools",
    "pypi_scipy",
    "pypi_sentencepiece",
    "pypi_torch",
    "pypi_torchvision",
    "pypi_tqdm",
    "pypi_transformers",
    "pypi_wandb",
    "pypi_webdataset"
  ]
}