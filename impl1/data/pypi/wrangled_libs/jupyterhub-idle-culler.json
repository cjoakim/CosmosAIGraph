{
  "classifiers": [],
  "description": "# jupyterhub idle culler service\n\n[![github workflow status - test](https://img.shields.io/github/workflow/status/jupyterhub/jupyterhub-idle-culler/test?logo=github&label=tests)](https://github.com/jupyterhub/jupyterhub-idle-culler/actions)\n[![latest pypi version](https://img.shields.io/pypi/v/jupyterhub-idle-culler?logo=pypi&logocolor=white)](https://pypi.python.org/pypi/jupyterhub-idle-culler)\n[![github](https://img.shields.io/badge/issue_tracking-github-blue?logo=github)](https://github.com/jupyterhub/jupyterhub-idle-culler/issues)\n[![discourse](https://img.shields.io/badge/help_forum-discourse-blue?logo=discourse)](https://discourse.jupyter.org/c/jupyterhub)\n[![gitter](https://img.shields.io/badge/social_chat-gitter-blue?logo=gitter)](https://gitter.im/jupyterhub/jupyterhub)\n\n`jupyterhub-idle-culler` provides a jupyterhub service to identify and shut down idle or long-running jupyter notebook servers.\nthe exact actions performed are dependent on the used spawner for the jupyter notebook server (e.g. the default [localprocessspawner](https://jupyterhub.readthedocs.io/en/stable/api/spawner.html#localprocessspawner>), [kubespawner](https://github.com/jupyterhub/kubespawner), or [dockerspawner](https://github.com/jupyterhub/dockerspawner)).\nin addition, if explicitly requested, all users whose jupyter notebook servers have been shut down this way are deleted as jupyterhub users from the internal database. this neither affects the authentication method which continues to allow those users to log in nor does it delete persisted user data (e.g. stored in docker volumes for dockerspawner or in persisted volumes for kubespawner).\n\n## setup\n\n### installation\n\n```bash\npip install jupyterhub-idle-culler\n```\n\n### permissions\n\nprior to jupyterhub 2.0, the `jupyterhub-idle-culler` required full administrative privileges,\nin order to have sufficient permissions to stop servers on behalf of users.\n\njupyterhub 2.0 introduces [scopes][] to allow for more fine-grained permission control.\nthis means that the configured culler service does not need full administrative privileges anymore.\nit can be assigned only the permissions it needs.\n\n[scopes]: https://jupyterhub.readthedocs.io/en/latest/rbac/scopes.html#available-scopes\n\n`jupyterhub-idle-culler` requires the following scopes to function:\n\n- `list:users` - access to the user list api, our source of information about who to cull\n- `read:users:activity` - read the last_activity field of the user\n- `delete:servers` - management of servers (this includes stopping servers)\n- `admin:users` (**optional**) - only needed if using `--cull-users`\n\nto assign the service the appropriate permissions, declare a role in your `jupyterhub_config.py`:\n\n```python\nc.jupyterhub.load_roles = [\n    {\n        \"name\": \"jupyterhub-idle-culler-role\",\n        \"scopes\": [\n            \"list:users\",\n            \"read:users:activity\",\n            \"delete:servers\",\n            # \"admin:users\", # if using --cull-users\n        ],\n        # assignment of role's permissions to:\n        \"services\": [\"jupyterhub-idle-culler-service\"],\n    }\n]\n```\n\n### as a hub managed service\n\nin `jupyterhub_config.py`, add the following dictionary for the idle-culler\nservice to the `c.jupyterhub.services` list:\n\n```python\nc.jupyterhub.services = [\n    {\n        \"name\": \"jupyterhub-idle-culler-service\",\n        \"command\": [\n            sys.executable,\n            \"-m\", \"jupyterhub_idle_culler\",\n            \"--timeout=3600\",\n        ],\n        # \"admin\": true,\n    }\n]\n```\n\nwhere:\n\n- `\"command\"` indicates that the service will be managed by the hub, and\n- `\"admin\": true` grants admin permissions to this service and is only meant for\n  use with jupyterhub < 2.0; see [above][permissions].\n\n### as a standalone script\n\n`jupyterhub-idle-culler` can also be run as a standalone script. it can\naccess the hub's api with a service token.\n\nregister the service token with jupyterhub in `jupyterhub_config.py`:\n\n```python\nc.jupyterhub.services = [\n    {\n        \"name\": \"jupyterhub-idle-culler-service\",\n        \"api_token\": \"...\",\n        # \"admin\": true,\n    }\n]\n```\n\nwhere:\n\n- `\"api_token\"` contains a secret token, e.g. generated by `openssl rand -hex 32`, and\n- `\"admin\": true` grants admin permissions to this service and is only meant for\n  use with jupyterhub < 2.0; see [above][permissions].\n\nand store the same token in a `jupyterhub_api_token` environment variable.\nthen start `jupyterhub-idle-culler` manually.\n\n```bash\nexport jupyterhub_api_token=api_token_above...\npython3 -m jupyterhub-idle-culler [--timeout=900] [--url=http://localhost:8081/hub/api]\n```\n\n## command line flags\n\n```\n  --api-page-size                  number of users to request per page, when\n                                   using jupyterhub 2.0's paginated user list\n                                   api. default: user the server-side default\n                                   configured page size. (default 0)\n  --concurrency                    limit the number of concurrent requests made\n                                   to the hub.  deleting a lot of users at the\n                                   same time can slow down the hub, so limit\n                                   the number of api requests we have\n                                   outstanding at any given time. (default 10)\n  --cull-admin-users               whether admin users should be culled (only\n                                   if --cull-users=true). (default true)\n  --cull-every                     the interval (in seconds) for checking for\n                                   idle servers to cull. (default 0)\n  --cull-users                     cull users in addition to servers.  this is\n                                   for use in temporary-user cases such as\n                                   tmpnb. (default false)\n  --internal-certs-location        the location of generated internal-ssl\n                                   certificates (only needed with --ssl-\n                                   enabled=true). (default internal-ssl)\n  --max-age                        the maximum age (in seconds) of servers that\n                                   should be culled even if they are active.\n                                   (default 0)\n  --remove-named-servers           remove named servers in addition to stopping\n                                   them.  this is useful for a binderhub that\n                                   uses authentication and named servers.\n                                   (default false)\n  --ssl-enabled                    whether the jupyter api endpoint has tls\n                                   enabled. (default false)\n  --timeout                        the idle timeout (in seconds). (default 600)\n  --url                            the jupyterhub api url.\n```\n\n## caveats\n\n1. last_activity is not updated with high frequency, so cull timeout should be\n   greater than the sum of:\n\n   - single-user websocket ping interval (default: 30 seconds)\n   - `jupyterhub.last_activity_interval` (default: 5 minutes)\n\n2. the same `--timeout` and `--max-age` values are used to cull\n   users and users' servers. if you want a different value for users and servers,\n   you should add this script to the services list twice, just with different\n   `name`s, different values, and one with the `--cull-users` option.\n\n3. by default http requests to the hub timeout after 60 seconds. this can be\n   changed by setting the `jupyterhub_request_timeout` environment variable.\n\n## how it works\n\njupytehrub-idle-culler lists available users via jupyterhub's [/users][users-api] rest api.\n\n[users-api]: https://jupyterhub.readthedocs.io/en/stable/_static/rest-api/index.html#path--users\n\njupyterhub-idle-culler culls user servers using jupyterhub's rest api\n([/users/{name}/server](https://jupyterhub.readthedocs.io/en/stable/_static/rest-api/index.html#operation--users--name--server-delete)\nor\n[/users/{name}/servers/{server_name}](https://jupyterhub.readthedocs.io/en/stable/_static/rest-api/index.html#operation--users--name--servers--server_name--delete)),\nand makes the culling decisions based on its configuration and what jupyterhub\nreports about the user servers via its rest api\n[(/users)][users-api]\nwhere user servers' `last_activity` is reported back.\n\nthe `last_activity` that jupyterhub reports is the most recent summary of\ninformation updated at a regular interval via the [`update_last_activity`\nfunction](https://github.com/jupyterhub/jupyterhub/blob/1.4.2/jupyterhub/app.py#l2646)\nthat combines two sources of information.\n\n1. **the proxy's routes data**\n\n   the `update_last_activity` function will [ask the\n   proxy](https://jupyterhub.readthedocs.io/en/stable/reference/proxy.html#retrieving-routes)\n   for the active routes like `/user/user1` and collects associated\n   `last_activity` data if it is available. this activity represents\n   successfully proxies network traffic.\n\n   `last_activity` data for routes will be available when using\n   [configurable-http-proxy](https://github.com/jupyterhub/configurable-http-proxy#readme)\n   as jupyterhub does by default, but if for example\n   [traefik-proxy](https://github.com/jupyterhub/traefik-proxy#readme) is used\n   as it is in the [tljh distribution](https://tljh.jupyter.org), no such data\n   will be available.\n\n2. **the user server's activity reports**\n\n   the `update_last_activity` function also reads jupyterhub's database that\n   keeps state about servers `last_activity`. these database records are updated\n   whenever a server notifies jupyterhub about activity, as they are\n   responsible to do.\n\n   servers notify jupyterhub about activity by being started by the\n   [`jupyterhub-singleuser`](https://github.com/jupyterhub/jupyterhub/blob/1.4.2/setup.py#l115)\n   script that is made available by installing jupyterhub (or `jupyterhub-base`\n   on conda-forge).\n\n   the `jupyterhub-singleuser` script launches a modified server application\n   that keeps jupyterhub updated with the server activity via the\n   [`notify_activity`](https://github.com/jupyterhub/jupyterhub/blob/1.4.2/jupyterhub/singleuser/mixins.py#l497)\n   function.\n\n   the `notify_activity` function in turn make use of the server applications\n   `last_activity` function (see implementation in\n   [notebookapp](https://github.com/jupyter/notebook/blob/v6.4.0/notebook/notebookapp.py#l392-l397)\n   and\n   [serverapp](https://github.com/jupyter-server/jupyter_server/blob/v1.9.0/jupyter_server/serverapp.py#l375)\n   respectively) that that combines information from api activity, kernel\n   activity, kernel shutdown, and terminal activity. this activity also covers\n   activity of applications like rstudio running via `jupyter-server-proxy`.\n\nhere is a summary of what's described so far:\n\n1. jupyterhub-idle-culler culls servers via jupyterhub's rest api.\n2. jupyterhub-idle-culler makes decisions based on information retrieved by\n   jupyterhub rest api.\n3. jupyterhub rest api reports information regularly updated by summarizing\n   information gained by: asking the proxy about routes' activity, and by\n   retaining activity information reported by the servers.\n\nnow, as the server's kernel activity influence the activity that servers will\nnotify jupyterhub about, the kernel activity in turn influences\njupyterhub-idle-culler. due to this, it can be relevant to also learn a little\nabout a mechanism to _cull idle kernels_ as well even though\njupyterhub-idle-culler isn't involved in that.\n\nthe default kernel manager, the mappingkernelmanager, can be configured to cull\nidle kernels. its configuration is documented in\n[notebookapp's](https://jupyter-notebook.readthedocs.io/en/stable/config.html#options)\nand\n[serverapp's](https://jupyter-server.readthedocs.io/en/latest/full-config.html)\nrespective documentation, and here are some relevant kernel culling\nconfiguration options:\n\n- `mappingkernelmanager.cull_busy`\n- `mappingkernelmanager.cull_idle_timeout`\n- `mappingkernelmanager.cull_interval`\n- `mappingkernelmanager.cull_connected`\n\n  note that `cull_connected` can be tricky to understand for jupyterlab as a\n  browser having a web-socket connection to a kernel or not isn't as obvious as\n  it was in the classical jupyter notebook ui. see [this issue for more\n  details](https://github.com/jupyterlab/jupyterlab/issues/6893).\n\n  also note that configuration of mappingkernelmanager should be made on the\n  user server itself, for example via a `jupyter_notebook_config.py` file in\n  `/etc/jupyter` or `/usr/local/etc/jupyter` rather than where jupyterhub is\n  running.\n\nfinally, note that a jupyter notebook server can shut itself down without\nwithout intervention by jupyterhub-idle-culler if\n`notebookapp.shutdown_no_activity_timeout` is configured.\n\n### caveats\n\n#### pagination\n\njupyterhub 2.0 introduces pagination to the [/users][users-api] api endpoint.\nthis pagination does not guarantee a consistent snapshot\nfor consecutive requests spread over time,\nso it is possible for a highly active hub to occasionally miss culling users crossing page boundaries between requests.\nthis is expected to be an infrequent occurrence and only result in delaying a server being culled by one cull interval\nin realistic scenarios, so of minor consequence in jupyterhub.\n\nthe issue can be mitigated by requesting a larger page size,\nvia e.g. `--api-page-size=200`,\nbut feel free to open an issue if this is causing a problem for you.\n\n\n",
  "docs_url": null,
  "keywords": "",
  "license": "3-bsd",
  "name": "jupyterhub-idle-culler",
  "package_url": "https://pypi.org/project/jupyterhub-idle-culler/",
  "project_url": "https://pypi.org/project/jupyterhub-idle-culler/",
  "project_urls": {
    "Homepage": "https://jupyter.org"
  },
  "release_url": "https://pypi.org/project/jupyterhub-idle-culler/1.2.1/",
  "requires_dist": [
    "tornado",
    "python-dateutil"
  ],
  "requires_python": ">=3.6",
  "summary": "",
  "version": "1.2.1",
  "releases": [],
  "developers": [
    "jupyter@googlegroups.com",
    "jupyter_development_team"
  ],
  "kwds": "jupyterhub_idle_culler jupyterhub_config jupyterhub_request_timeout jupyterhub_api_token jupyterhub",
  "license_kwds": "3-bsd",
  "libtype": "pypi",
  "id": "pypi_jupyterhub_idle_culler",
  "homepage": "https://jupyter.org",
  "release_count": 4,
  "dependency_ids": [
    "pypi_python_dateutil",
    "pypi_tornado"
  ]
}