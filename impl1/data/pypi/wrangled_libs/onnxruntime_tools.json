{
  "classifiers": [
    "development status :: 4 - beta",
    "environment :: console",
    "intended audience :: developers",
    "license :: osi approved :: mit license",
    "operating system :: microsoft :: windows",
    "operating system :: posix",
    "programming language :: python :: 3 :: only",
    "programming language :: python :: 3.5",
    "programming language :: python :: 3.6",
    "programming language :: python :: 3.7",
    "programming language :: python :: 3.8"
  ],
  "description": "# transformer model optimization tool overview\n\nonnx runtime automatically applies most optimizations while loading a transformer model. some of the latest optimizations that have not yet been integrated into onnx runtime are available in this tool that tunes models for the best performance.\n\nthis tool can help in the following senarios:\n* model is exported by tf2onnx or keras2onnx, and onnx runtime does not have graph optimization for them right now.\n* convert model to use float16 to boost performance using mixed precision on gpus with tensor cores (like v100 or t4).\n* model has inputs with dynamic axis, which blocks some optimizations to be applied in onnx runtime due to shape inference.\n* disable or enable some fusions to see its impact on performance or accuracy.\n\n## installation\n\nfirst you need install onnxruntime or onnxruntime-gpu package for cpu or gpu inference. to use onnxruntime-gpu, it is required to install cuda and cudnn and add their bin directories to path environment variable.\n\n## limitations\n\ndue to cuda implementation of attention kernel, maximum number of attention heads is 1024. normally, maximum supported sequence length is 4096 for longformer and 1024 for other types of models.\n\n## export a transformer model to onnx\n\npytorch could export model to onnx. the tf2onnx and keras2onnx tools can be used to convert model that trained by tensorflow.\nhuggingface transformers has a [notebook](https://github.com/huggingface/transformers/blob/master/notebooks/04-onnx-export.ipynb) shows an example of exporting a pretrained model to onnx.\nfor keras2onnx, please refer to its [example script](https://github.com/onnx/keras-onnx/blob/master/applications/nightly_build/test_transformers.py).\nfor tf2onnx, please refer to its [bert tutorial](https://github.com/onnx/tensorflow-onnx/blob/master/tutorials/berttutorial.ipynb).\n\n### gpt-2 model conversion\n\nconverting gpt-2 model from pytorch to onnx is not straightforward when past state is used. we add a tool [convert_to_onnx](https://github.com/microsoft/onnxruntime/blob/master/onnxruntime/python/tools/transformers/convert_to_onnx.py) to help you.\n\nyou can use commands like the following to convert a pre-trained pytorch gpt-2 model to onnx for given precision (float32, float16 or int8):\n```\npython -m onnxruntime.transformers.convert_to_onnx -m gpt2 --model_class gpt2lmheadmodel --output gpt2.onnx -p fp32\npython -m onnxruntime.transformers.convert_to_onnx -m distilgpt2 --model_class gpt2lmheadmodel --output distilgpt2.onnx -p fp16 --use_gpu --optimize_onnx\npython -m onnxruntime.transformers.convert_to_onnx -m [path_to_gpt2_pytorch_model_directory] --output quantized.onnx -p int32 --optimize_onnx\n```\n\nthe tool will also verify whether the onnx model and corresponding pytorch model generate same outputs given same random inputs.\n\n### longformer model conversion\n\nrequirement: linux os (for example ubuntu 18.04 or 20.04) and a python environment like the following:\n```\nconda create -n longformer python=3.6\nconda activate longformer\nconda install pytorch torchvision torchaudio cpuonly -c pytorch\npip install onnx transformers onnxruntime\n```\nnext, get the source of [torch extensions for longformer exporting](https://github.com/microsoft/onnxruntime/tree/master/onnxruntime/python/tools/transformers/torch_extensions), and run the following:\n```\npython setup.py install\n```\nit will generate file like \"build/lib.linux-x86_64-3.6/longformer_attention.cpython-36m-x86_64-linux-gnu.so\" under the directory.\n\nfinally, use [convert_longformer_to_onnx](https://github.com/microsoft/onnxruntime/blob/master/onnxruntime/python/tools/transformers/longformer/convert_longformer_to_onnx.py) to convert to onnx model like the following:\n```\npython convert_longformer_to_onnx.py -m longformer-base-4096\n```\n\nthe exported onnx model can only run in gpu right now.\n\n## model optimizer\n\nin your python code, you can use the optimizer like the following:\n\n```python\nfrom onnxruntime.transformers import optimizer\noptimized_model = optimizer.optimize_model(\"gpt2.onnx\", model_type='gpt2', num_heads=12, hidden_size=768)\noptimized_model.convert_model_float32_to_float16()\noptimized_model.save_model_to_file(\"gpt2_fp16.onnx\")\n```\n\nyou can also use command line. example of optimizing a bert-large model to use mixed precision (float16):\n```console\npython -m onnxruntime.transformers.optimizer --input bert_large.onnx --output bert_large_fp16.onnx --num_heads 16 --hidden_size 1024 --float16\n```\n\nyou can also download the latest script files from [here](https://github.com/microsoft/onnxruntime/tree/master/onnxruntime/python/tools/transformers/). then run it like the following:\n```console\npython optimizer.py --input gpt2.onnx --output gpt2_opt.onnx --model_type gpt2\n```\n\n### optimizer options\n\nsee below for description of some options of optimizer.py:\n\n- **input**: input model path\n- **output**: output model path\n- **model_type**: (*defaul: bert*)\n    there are 4 model types: *bert* (exported by pytorch), *gpt2* (exported by pytorch), and *bert_tf* (bert exported by tf2onnx), *bert_keras* (bert exported by keras2onnx) respectively.\n- **num_heads**: (*default: 12*)\n    number of attention heads. bert-base and bert-large has 12 and 16 respectively.\n- **hidden_size**: (*default: 768*)\n    bert-base and bert-large has 768 and 1024 hidden nodes respectively.\n- **input_int32**: (*optional*)\n    exported model ususally uses int64 tensor as input. if this flag is specified, int32 tensors will be used as input, and it could avoid un-necessary cast nodes and get better performance.\n- **float16**: (*optional*)\n    by default, model uses float32 in computation. if this flag is specified, half-precision float will be used. this option is recommended for nvidia gpu with tensor core like v100 and t4. for older gpus, float32 is likely faster.\n-  **use_gpu**: (*optional*)\n    when opt_level > 1, please set this flag for gpu inference.\n- **opt_level**: (*optional*)\n    set a proper graph optimization level of onnxruntime: 0 - disable all (default), 1 - basic, 2 - extended, 99 - all. if the value is positive, onnxruntime will be used to optimize graph first.\n- **verbose**: (*optional*)\n    print verbose information when this flag is specified.\n\n### supported models\n\nhere is a list of pytorch models from [huggingface transformers](https://github.com/huggingface/transformers/) that have been tested using the optimizer:\n- bert\n- distilbert\n- distilgpt2\n- roberta\n- albert\n- gpt-2 (**gpt2model**, **gpt2lmheadmodel**)\n\nfor tensorflow model, we only tested bert model so far.\n\nmost optimizations require exact match of a subgraph. any layout change in subgraph might cause some optimization not working. note that different versions of training or export tool might lead to different graph layouts. it is recommended to use latest released version of pytorch and transformers.\n\nif your model is not in the list, it might only be partial optimized or not optimized at all.\n\n\n## benchmark\nthere is a bash script [run_benchmark.sh](https://github.com/microsoft/onnxruntime/blob/master/onnxruntime/python/tools/transformers/run_benchmark.sh) for running benchmark. you can modify the bash script to choose your options (like models to test, batch sizes, sequence lengths, target device etc) before running.\n\nthe bash script will call benchmark.py script to measure inference performance of onnxruntime, pytorch or pytorch+torchscript on pretrained models of huggingface transformers.\n\n### benchmark results on v100\n\nin the following benchmark results, onnx runtime uses optimizer for model optimization, and io binding is enabled.\n\nwe tested on tesla v100-pcie-16gb gpu (cpu is intel xeon(r) e5-2690 v4) for different batch size (**b**) and sequence length (**s**). below result is average latency of per inference in miliseconds.\n\n#### bert-base-uncased (bertmodel)\n\nthe model has 12 layers and 768 hidden, with input_ids as input.\n\n| engine      | version | precision | b | s=8  | s=16 | s=32 | s=64 | s=128 | s=256 | s=512 |\n|-------------|---------|-----------|---|------|------|------|------|-------|-------|-------|\n| torchscript | 1.5.1   | fp32      | 1 | 7.92 | 8.78 | 8.91 | 9.18 | 9.56  | 9.39  | 12.83 |\n| onnxruntime | 1.4.0   | fp32      | 1 | 1.38 | 1.42 | 1.67 | 2.15 | 3.11  | 5.37  | 10.74 |\n| onnxruntime | 1.4.0   | fp16      | 1 | 1.30 | 1.29 | 1.31 | 1.33 | 1.45  | 1.95  | 3.36  |\n| onnxruntime | 1.4.0   | fp32      | 4 | 1.51 | 1.93 | 2.98 | 5.01 | 9.13  | 17.95 | 38.15 |\n| onnxruntime | 1.4.0   | fp16      | 4 | 1.27 | 1.35 | 1.43 | 1.83 | 2.66  | 4.40  | 9.76  |\n\n[run_benchmark.sh](https://github.com/microsoft/onnxruntime/blob/master/onnxruntime/python/tools/transformers/run_benchmark.sh) is used to get the results.\n\n#### gpt2 (gpt2lmheadmodel)\n\nthe model has 12 layers and 768 hidden, with input_ids, position_ids, attention_mask and past state as inputs.\n\n| engine      | version | precision | b | s=4  | s=8 | s=32 | s=128 |\n|-------------|---------|-----------|---|------|------|------|------|\n| torchscript | 1.5.1   | fp32      | 1 | 5.80 | 5.77 | 5.82 | 5.78 |\n| onnxruntime | 1.4.0   | fp32      | 1 | 1.42 | 1.42 | 1.43 | 1.47 |\n| onnxruntime | 1.4.0   | fp16      | 1 | 1.54 | 1.54 | 1.58 | 1.64 |\n| onnxruntime | 1.4.0   | fp32      | 8 | 1.83 | 1.84 | 1.90 | 2.13 |\n| onnxruntime | 1.4.0   | fp16      | 8 | 1.74 | 1.75 | 1.81 | 2.09 |\n| onnxruntime | 1.4.0   | fp32      | 32 | 2.19 | 2.21 | 2.45 | 3.34 |\n| onnxruntime | 1.4.0   | fp16      | 32 | 1.66 | 1.71 | 1.85 | 2.73 |\n| onnxruntime | 1.4.0   | fp32      | 128 | 4.15 | 4.37 | 5.15 | 8.61 |\n| onnxruntime | 1.4.0   | fp16      | 128 | 2.47 | 2.58 | 3.26 | 6.16 |\n\nsince past state is used, sequence length in input_ids is 1. for example, s=4 means the past sequence length is 4 and the total sequence length is 5.\n\n[benchmark_gpt2.py](https://github.com/microsoft/onnxruntime/blob/master/onnxruntime/python/tools/transformers/benchmark_gpt2.py) is used to get the results like the following commands:\n\n```console\npython -m onnxruntime.transformers.benchmark_gpt2 --use_gpu -m gpt2 -o -v -b 1 8 32 128 -s 4 8 32 128 -p fp32\npython -m onnxruntime.transformers.benchmark_gpt2 --use_gpu -m gpt2 -o -v -b 1 8 32 128 -s 4 8 32 128 -p fp16\n```\n\n### benchmark.py\n\nif you use run_benchmark.sh, you need not use benchmark.py directly. you can skip this section if you do not want to know the details.\n\nbelow is example to runing benchmark.py on pretrained model bert-base-cased on gpu.\n\n```console\npython -m onnxruntime.transformers.benchmark -g -m bert-base-cased -o -v -b 0\npython -m onnxruntime.transformers.benchmark -g -m bert-base-cased -o\npython -m onnxruntime.transformers.benchmark -g -m bert-base-cased -e torch\npython -m onnxruntime.transformers.benchmark -g -m bert-base-cased -e torchscript\n```\nthe first command will generate onnx models (both before and after optimizations), but not run performance tests since batch size is 0. the other three commands will run performance test on each of three engines: onnxruntime, pytorch and pytorch+torchscript.\n\nif you remove -o parameter, optimizer script is not used in benchmark.\n\nif your gpu (like v100 or t4) has tensorcore, you can append `-p fp16` to the above commands to enable mixed precision.\n\nif you want to benchmark on cpu, you can remove -g option in the commands.\n\nnote that our current benchmark on gpt2 and distilgpt2 models has disabled past state from inputs and outputs.\n\nby default, onnx model has only one input (input_ids). you can use -i parameter to test models with multiple inputs. for example, we can add \"-i 3\" to command line to test a bert model with 3 inputs (input_ids, token_type_ids and attention_mask). this option only supports onnxruntime right now.\n\n## bert model verification\n\nif your bert model has three inputs (like input_ids, token_type_ids and attention_mask), a script compare_bert_results.py can be used to do a quick verification. the tool will generate some fake input data, and compare results from both the original and optimized models. if outputs are all close, it is safe to use the optimized model.\n\nexample of verifying models optimized for cpu:\n\n```console\npython -m onnxruntime.transformers.compare_bert_results --baseline_model original_model.onnx --optimized_model optimized_model_cpu.onnx --batch_size 1 --sequence_length 128 --samples 100\n```\n\nfor gpu, please append --use_gpu to the command.\n\n## performance test\n\nbert_perf_test.py can be used to check the bert model inference performance. below are examples:\n\n```console\npython -m onnxruntime.transformers.bert_perf_test --model optimized_model_cpu.onnx --batch_size 1 --sequence_length 128\n```\n\nfor gpu, please append --use_gpu to the command.\n\nafter test is finished, a file like perf_results_cpu_b1_s128_<date_time>.txt or perf_results_gpu_b1_s128_<date_time>.txt will be output to the model directory.\n\n## profiling\n\nprofiler.py can be used to run profiling on a transformer model. it can help figure out the bottleneck of a model, and cpu time spent on a node or subgraph.\n\nexamples commands:\n\n```console\npython -m onnxruntime.transformers.profiler --model bert.onnx --batch_size 8 --sequence_length 128 --samples 1000 --dummy_inputs bert --thread_num 8 --kernel_time_only\npython -m onnxruntime.transformers.profiler --model gpt2.onnx --batch_size 1 --sequence_length 1 --past_sequence_length 128 --samples 1000 --dummy_inputs gpt2 --use_gpu\npython -m onnxruntime.transformers.profiler --model longformer.onnx --batch_size 1 --sequence_length 4096 --global_length 8 --samples 1000 --dummy_inputs longformer --use_gpu\n```\n\nresult file like onnxruntime_profile__<date_time>.json will be output to current directory. summary of nodes, top expensive nodes and results grouped by operator type will be printed to console.\n\n\n",
  "docs_url": null,
  "keywords": "",
  "license": "mit license",
  "name": "onnxruntime-tools",
  "package_url": "https://pypi.org/project/onnxruntime-tools/",
  "project_url": "https://pypi.org/project/onnxruntime-tools/",
  "project_urls": {
    "Homepage": "https://github.com/microsoft/onnxruntime"
  },
  "release_url": "https://pypi.org/project/onnxruntime-tools/1.7.0/",
  "requires_dist": [
    "onnx",
    "numpy",
    "coloredlogs",
    "psutil",
    "py-cpuinfo",
    "py3nvml",
    "packaging"
  ],
  "requires_python": "",
  "summary": "transformers model optimization tool of onnxruntime",
  "version": "1.7.0",
  "releases": [],
  "developers": [
    "microsoft_corporation",
    "onnx@microsoft.com"
  ],
  "kwds": "optimize_onnx tensorflow keras2onnx onnxruntime convert_longformer_to_onnx",
  "license_kwds": "mit license",
  "libtype": "pypi",
  "id": "pypi_onnxruntime_tools",
  "homepage": "https://github.com/microsoft/onnxruntime",
  "release_count": 12,
  "dependency_ids": [
    "pypi_coloredlogs",
    "pypi_numpy",
    "pypi_onnx",
    "pypi_packaging",
    "pypi_psutil",
    "pypi_py_cpuinfo",
    "pypi_py3nvml"
  ]
}