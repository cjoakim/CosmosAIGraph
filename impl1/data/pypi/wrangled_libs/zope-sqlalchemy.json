{
  "classifiers": [
    "development status :: 5 - production/stable",
    "framework :: pyramid",
    "framework :: zope :: 3",
    "framework :: zope :: 5",
    "intended audience :: developers",
    "license :: osi approved :: zope public license",
    "programming language :: python",
    "programming language :: python :: 3",
    "programming language :: python :: 3.10",
    "programming language :: python :: 3.11",
    "programming language :: python :: 3.7",
    "programming language :: python :: 3.8",
    "programming language :: python :: 3.9",
    "programming language :: python :: implementation :: cpython",
    "topic :: database",
    "topic :: software development :: libraries :: python modules"
  ],
  "description": "***************\nzope.sqlalchemy\n***************\n\n.. contents::\n   :local:\n\nintroduction\n============\n\nthe aim of this package is to unify the plethora of existing packages\nintegrating sqlalchemy with zope's transaction management. as such it seeks\nonly to provide a data manager and makes no attempt to define a `zopeish` way\nto configure engines.\n\nfor wsgi applications, zope style automatic transaction management is\navailable with `repoze.tm2`_ (used by `turbogears 2`_ and other systems).\n\nthis package is also used by `pyramid_tm`_ (an add-on of the `pyramid`_) web\nframework.\n\nyou need to understand `sqlalchemy`_ and the `zope transaction manager`_ for\nthis package and this readme to make any sense.\n\n.. _repoze.tm2: https://repozetm2.readthedocs.io/en/latest/\n\n.. _pyramid_tm: https://docs.pylonsproject.org/projects/pyramid_tm/en/latest/\n\n.. _pyramid: https://pylonsproject.org/\n\n.. _turbogears 2: https://turbogears.org/\n\n.. _sqlalchemy: https://sqlalchemy.org/docs/\n\n.. _zope transaction manager: https://www.zodb.org/en/latest/#transactions\n\nrunning the tests\n=================\n\nthis package is distributed as a buildout. using your desired python run:\n\n$ python bootstrap.py\n$ ./bin/buildout\n\nthis will download the dependent packages and setup the test script, which may\nbe run with:\n\n$ ./bin/test\n\nor with the standard setuptools test command:\n\n$ ./bin/py setup.py test\n\nto enable testing with your own database set the test_dsn environment variable\nto your sqlalchemy database dsn. two-phase commit behaviour may be tested by\nsetting the test_twophase variable to a non empty string. e.g:\n\n$ test_dsn=postgres://test:test@localhost/test test_twophase=true bin/test\n\nusage in short\n==============\n\nthe integration between zope transactions and the sqlalchemy event system is\ndone using the ``register()`` function on the session factory class.\n\n.. code-block:: python\n\n    from zope.sqlalchemy import register\n    from sqlalchemy import create_engine\n    from sqlalchemy.orm import sessionmaker, scoped_session\n\n    engine = sqlalchemy.create_engine(\"postgresql://scott:tiger@localhost/test\")\n\n    dbsession = scoped_session(sessionmaker(bind=engine))\n    register(dbsession)\n\ninstantiated sessions commits and rollbacks will now be integrated with zope\ntransactions.\n\n.. code-block:: python\n\n    import transaction\n    from sqlalchemy.sql import text\n\n    session = dbsession()\n\n    result = session.execute(text(\"delete from objects where id=:id\"), {\"id\": 2})\n    row = result.fetchone()\n\n    transaction.commit()\n\n\nfull example\n============\n\nthis example is lifted directly from the sqlalchemy declarative documentation.\nfirst the necessary imports.\n\n    >>> from sqlalchemy import *\n    >>> from sqlalchemy.orm import declarative_base, scoped_session, sessionmaker, relationship\n    >>> from sqlalchemy.sql import text\n    >>> from zope.sqlalchemy import register\n    >>> import transaction\n\nnow to define the mapper classes.\n\n    >>> base = declarative_base()\n    >>> class user(base):\n    ...     __tablename__ = 'test_users'\n    ...     id = column('id', integer, primary_key=true)\n    ...     name = column('name', string(50))\n    ...     addresses = relationship(\"address\", backref=\"user\")\n    >>> class address(base):\n    ...     __tablename__ = 'test_addresses'\n    ...     id = column('id', integer, primary_key=true)\n    ...     email = column('email', string(50))\n    ...     user_id = column('user_id', integer, foreignkey('test_users.id'))\n\ncreate an engine and setup the tables. note that for this example to work a\nrecent version of sqlite/pysqlite is required. 3.4.0 seems to be sufficient.\n\n    >>> engine = create_engine(test_dsn)\n    >>> base.metadata.create_all(engine)\n\nnow to create the session itself. as zope is a threaded web server we must use\nscoped sessions. zope and sqlalchemy sessions are tied together by using the\nregister\n\n    >>> session = scoped_session(sessionmaker(bind=engine,\n    ... twophase=test_twophase))\n\ncall the scoped session factory to retrieve a session. you may call this as\nmany times as you like within a transaction and you will always retrieve the\nsame session. at present there are no users in the database.\n\n    >>> session = session()\n    >>> register(session)\n    <zope.sqlalchemy.datamanager.zopetransactionevents object at ...>\n    >>> session.query(user).all()\n    []\n\nwe can now create a new user and commit the changes using zope's transaction\nmachinery, just as zope's publisher would.\n\n    >>> session.add(user(id=1, name='bob'))\n    >>> transaction.commit()\n\nengine level connections are outside the scope of the transaction integration.\n\n    >>> engine.connect().execute(text('select * from test_users')).fetchall()\n    [(1, ...'bob')]\n\na new transaction requires a new session. let's add an address.\n\n    >>> session = session()\n    >>> bob = session.query(user).all()[0]\n    >>> str(bob.name)\n    'bob'\n    >>> bob.addresses\n    []\n    >>> bob.addresses.append(address(id=1, email='bob@bob.bob'))\n    >>> transaction.commit()\n    >>> session = session()\n    >>> bob = session.query(user).all()[0]\n    >>> bob.addresses\n    [<address object at ...>]\n    >>> str(bob.addresses[0].email)\n    'bob@bob.bob'\n    >>> bob.addresses[0].email = 'wrong@wrong'\n\nto rollback a transaction, use transaction.abort().\n\n    >>> transaction.abort()\n    >>> session = session()\n    >>> bob = session.query(user).all()[0]\n    >>> str(bob.addresses[0].email)\n    'bob@bob.bob'\n    >>> transaction.abort()\n\nby default, zope.sqlalchemy puts sessions in an 'active' state when they are\nfirst used. orm write operations automatically move the session into a\n'changed' state. this avoids unnecessary database commits. sometimes it\nis necessary to interact with the database directly through sql. it is not\npossible to guess whether such an operation is a read or a write. therefore we\nmust manually mark the session as changed when manual sql statements write\nto the db.\n\n    >>> session = session()\n    >>> conn = session.connection()\n    >>> users = base.metadata.tables['test_users']\n    >>> conn.execute(users.update().where(users.c.name=='bob'), {'name': 'ben'})\n    <sqlalchemy.engine... object at ...>\n    >>> from zope.sqlalchemy import mark_changed\n    >>> mark_changed(session)\n    >>> transaction.commit()\n    >>> session = session()\n    >>> str(session.query(user).all()[0].name)\n    'ben'\n    >>> transaction.abort()\n\nif this is a problem you may register the events and tell them to place the\nsession in the 'changed' state initially.\n\n    >>> session.remove()\n    >>> register(session, 'changed')\n    <zope.sqlalchemy.datamanager.zopetransactionevents object at ...>\n    >>> session = session()\n    >>> conn = session.connection()\n    >>> conn.execute(users.update().where(users.c.name=='ben'), {'name': 'bob'})\n    <sqlalchemy.engine... object at ...>\n    >>> transaction.commit()\n    >>> session = session()\n    >>> str(session.query(user).all()[0].name)\n    'bob'\n    >>> transaction.abort()\n\nthe `mark_changed` function accepts a kwarg for `keep_session` which defaults\nto `false` and is unaware of the registered extensions `keep_session`\nconfiguration.\n\nif you intend for `keep_session` to be true, you can specify it explicitly:\n\n    >>> from zope.sqlalchemy import mark_changed\n    >>> mark_changed(session, keep_session=true)\n    >>> transaction.commit()\n\nyou can also use a configured extension to preserve this argument:\n\n    >>> sessionextension = register(session, keep_session=true)\n    >>> sessionextension.mark_changed(session)\n    >>> transaction.commit()\n\n\nlong-lasting session scopes\n---------------------------\n\nthe default behaviour of the transaction integration is to close the session\nafter a commit. you can tell by trying to access an object after committing:\n\n    >>> bob = session.query(user).all()[0]\n    >>> transaction.commit()\n    >>> bob.name\n    traceback (most recent call last):\n    sqlalchemy.orm.exc.detachedinstanceerror: instance <user at ...> is not bound to a session; attribute refresh operation cannot proceed...\n\nto support cases where a session needs to last longer than a transaction (useful\nin test suites) you can specify to keep a session when registering the events:\n\n    >>> session = scoped_session(sessionmaker(bind=engine,\n    ... twophase=test_twophase))\n    >>> register(session, keep_session=true)\n    <zope.sqlalchemy.datamanager.zopetransactionevents object at ...>\n    >>> session = session()\n    >>> bob = session.query(user).all()[0]\n    >>> bob.name = 'bobby'\n    >>> transaction.commit()\n    >>> bob.name\n    'bobby'\n\nthe session must then be closed manually:\n\n    >>> session.close()\n\n\ndevelopment version\n===================\n\n`git version <https://github.com/zopefoundation/zope.sqlalchemy>`_\n\n\nchanges\n=======\n\n3.1 (2023-09-12)\n----------------\n\n- fix ``psycopg.errors.operationalerror.sqlstate`` can be ``none``.\n  (`#81 <https://github.com/zopefoundation/zope.sqlalchemy/issues/81>`_)\n\n\n3.0 (2023-06-01)\n----------------\n\n- add support for sqlalchemy 2.0 and for new psycopg v3 backend.\n  (`#79 <https://github.com/zopefoundation/zope.sqlalchemy/pull/79>`_)\n\n**breaking changes**\n\n- no longer allow calling ``session.commit()`` within a manual nested database\n  transaction (a savepoint). if you want to use savepoints directly in code that is\n  not aware of ``transaction.savepoint()`` with ``session.begin_nested()`` then\n  use the savepoint returned by the function to commit just the nested transaction\n  i.e. ``savepoint = session.begin_nested(); savepoint.commit()`` or use it as a\n  context manager i.e. ``with session.begin_nested():``.\n  (`for details see #79 <https://github.com/zopefoundation/zope.sqlalchemy/pull/79#issuecomment-1516069841>`_)\n\n\n2.0 (2023-02-06)\n----------------\n\n- drop support for python 2.7, 3.5, 3.6.\n\n- drop support for ``sqlalchemy < 1.1``\n  (`#65 <https://github.com/zopefoundation/zope.sqlalchemy/issues/65>`_)\n\n- add support for python 3.10, 3.11.\n\n\n1.6 (2021-09-06)\n----------------\n\n- add support for python 2.7 on sqlalchemy 1.4.\n  (`#71 <https://github.com/zopefoundation/zope.sqlalchemy/issues/71>`_)\n\n\n1.5 (2021-07-14)\n----------------\n\n- call ``mark_changed`` also on the ``do_orm_execute`` event if the operation\n  is an insert, update or delete. this is sqlalchemy >= 1.4 only, as it\n  introduced that event.\n  (`#67 <https://github.com/zopefoundation/zope.sqlalchemy/issues/67>`_)\n\n- fixup get transaction. there was regression introduced in 1.4.\n  (`#66 <https://github.com/zopefoundation/zope.sqlalchemy/issues/66>`_)\n\n\n1.4 (2021-04-26)\n----------------\n\n- add ``mark_changed`` and ``join_transaction`` methods to\n  ``zopetransactionevents``.\n  (`#46 <https://github.com/zopefoundation/zope.sqlalchemy/issues/46>`_)\n\n- reduce deprecationwarnings with sqlalchemy 1.4 and require at least\n  sqlalchemy >= 0.9.\n  (`#54 <https://github.com/zopefoundation/zope.sqlalchemy/issues/54>`_)\n\n- add support for sqlalchemy 1.4.\n  (`#58 <https://github.com/zopefoundation/zope.sqlalchemy/issues/58>`_)\n\n- prevent using an sqlalchemy 1.4 version with broken flush support.\n  (`#57 <https://github.com/zopefoundation/zope.sqlalchemy/issues/57>`_)\n\n\n1.3 (2020-02-17)\n----------------\n\n* ``.datamanager.register()`` now returns the ``zopetransactionevents``\n  instance which was used to register the events. this allows to change its\n  parameters afterwards.\n  (`#40 <https://github.com/zopefoundation/zope.sqlalchemy/pull/40>`_)\n\n* add preliminary support for python 3.9a3.\n\n\n1.2 (2019-10-17)\n----------------\n\n**breaking changes**\n\n* drop support for python 3.4.\n\n* add support for python 3.7 and 3.8.\n\n* fix deprecation warnings for the event system. we already used it in general\n  but still leveraged the old extension mechanism in some places.\n  (`#31 <https://github.com/zopefoundation/zope.sqlalchemy/issues/31>`_)\n\n  to make things clearer we renamed the ``zopetransactionextension`` class\n  to ``zopetransactionevents``. existing code using the 'register' version\n  stays compatible.\n\n**upgrade from 1.1**\n\nyour old code like this:\n\n.. code-block:: python\n\n    from zope.sqlalchemy import zopetransactionextension\n\n    dbsession = scoped_session(sessionmaker(extension=zopetransactionextension(), **options))\n\nbecomes:\n\n.. code-block:: python\n\n    from zope.sqlalchemy import register\n\n    dbsession = scoped_session(sessionmaker(**options))\n    register(dbsession)\n\n\n\n1.1 (2019-01-03)\n----------------\n\n* add support to mysql using pymysql.\n\n\n1.0 (2018-01-31)\n----------------\n\n* add support for python 3.4 up to 3.6.\n\n* support sqlalchemy 1.2.\n\n* drop support for python 2.6, 3.2 and 3.3.\n\n* drop support for transaction < 1.6.0.\n\n* fix hazard that could cause sqlalchemy session not to be committed when\n  transaction is committed in rare situations.\n  (`#23 <https://github.com/zopefoundation/zope.sqlalchemy/pull/23>`_)\n\n\n0.7.7 (2016-06-23)\n------------------\n\n* support sqlalchemy 1.1.\n  (`#15 <https://github.com/zopefoundation/zope.sqlalchemy/issues/15>`_)\n\n\n0.7.6 (2015-03-20)\n------------------\n\n* make version check in register compatible with prereleases.\n\n0.7.5 (2014-06-17)\n------------------\n\n* ensure mapped objects are expired following a ``transaction.commit()`` when\n  no database commit was required.\n  (`#8 <https://github.com/zopefoundation/zope.sqlalchemy/issues/8>`_)\n\n\n0.7.4 (2014-01-06)\n------------------\n\n* allow ``session.commit()`` on nested transactions to facilitate integration\n  of existing code that might not use ``transaction.savepoint()``.\n  (`#1 <https://github.com/zopefoundation/zope.sqlalchemy/issues/1>`_)\n\n* add a new function zope.sqlalchemy.register(), which replaces the\n  direct use of zopetransactionextension to make use\n  of the newer sqlalchemy event system to establish instrumentation on\n  the given session instance/class/factory.   requires at least\n  sqlalchemy 0.7.\n  (`#4 <https://github.com/zopefoundation/zope.sqlalchemy/issues/4>`_)\n\n* fix `keep_session=true` doesn't work when a transaction is joined by flush\n  and other manngers bug.\n  (`#5 <https://github.com/zopefoundation/zope.sqlalchemy/issues/5>`_)\n\n\n0.7.3 (2013-09-25)\n------------------\n\n* prevent the ``session`` object from getting into a \"wedged\" state if joining\n  a transaction fails. with thread scoped sessions that are reused this can cause\n  persistent errors requiring a server restart.\n  (`#2 <https://github.com/zopefoundation/zope.sqlalchemy/issues/2>`_)\n\n0.7.2 (2013-02-19)\n------------------\n\n* make life-time of sessions configurable. specify `keep_session=true` when\n  setting up the sa extension.\n\n* python 3.3 compatibility.\n\n0.7.1 (2012-05-19)\n------------------\n\n* use ``@implementer`` as a class decorator instead of ``implements()`` at\n  class scope for compatibility with ``zope.interface`` 4.0.  this requires\n  ``zope.interface`` >= 3.6.0.\n\n0.7 (2011-12-06)\n----------------\n\n* python 3.2 compatibility.\n\n0.6.1 (2011-01-08)\n------------------\n\n* update datamanager.mark_changed to handle sessions which have not yet logged\n  a (orm) query.\n\n\n0.6 (2010-07-24)\n----------------\n\n* implement should_retry for sqlalchemy.orm.exc.concurrentmodificationerror\n  and serialization errors from postgresql and oracle.\n  (specify transaction>=1.1 to use this functionality.)\n\n* include license files.\n\n* add ``transaction_manager`` attribute to data managers for compliance with\n  idatamanager interface.\n\n0.5 (2010-06-07)\n----------------\n\n* remove redundant session.flush() / session.clear() on savepoint operations.\n  these were only needed with sqlalchemy 0.4.x.\n\n* sqlalchemy 0.6.x support. require sqlalchemy >= 0.5.1.\n\n* add support for running ``python setup.py test``.\n\n* pull in pysqlite explicitly as a test dependency.\n\n* setup sqlalchemy mappers in test setup and clear them in tear down. this\n  makes the tests more robust and clears up the global state after. it\n  caused the tests to fail when other tests in the same run called\n  clear_mappers.\n\n0.4 (2009-01-20)\n----------------\n\nbugs fixed:\n\n* only raise errors in tpc_abort if we have committed.\n\n* remove the session id from the session_state just before we de-reference the\n  session (i.e. all work is already successfuly completed). this fixes cases\n  where the transaction commit failed but session_state was already cleared.  in\n  those cases, the transaction was wedeged as abort would always error.  this\n  happened on postgresql where invalid sql was used and the error caught.\n\n* call session.flush() unconditionally in tpc_begin.\n\n* change error message on session.commit() to be friendlier to non zope users.\n\nfeature changes:\n\n* support for bulk update and delete with sqlalchemy 0.5.1\n\n0.3 (2008-07-29)\n----------------\n\nbugs fixed:\n\n* new objects added to a session did not cause a transaction join, so were not\n  committed at the end of the transaction unless the database was accessed.\n  sqlalchemy 0.4.7 or 0.5beta3 now required.\n\nfeature changes:\n\n* for correctness and consistency with zodb, renamed the function 'invalidate'\n  to 'mark_changed' and the status 'invalidated' to 'changed'.\n\n0.2 (2008-06-28)\n----------------\n\nfeature changes:\n\n* updated to support sqlalchemy 0.5. (0.4.6 is still supported).\n\n0.1 (2008-05-15)\n----------------\n\n* initial public release.\n",
  "docs_url": null,
  "keywords": "zope zope3 sqlalchemy",
  "license": "zpl 2.1",
  "name": "zope.sqlalchemy",
  "package_url": "https://pypi.org/project/zope.sqlalchemy/",
  "project_url": "https://pypi.org/project/zope.sqlalchemy/",
  "project_urls": {
    "Homepage": "https://github.com/zopefoundation/zope.sqlalchemy"
  },
  "release_url": "https://pypi.org/project/zope.sqlalchemy/3.1/",
  "requires_dist": [
    "packaging",
    "setuptools",
    "SQLAlchemy !=1.4.0,!=1.4.1,!=1.4.2,!=1.4.3,!=1.4.4,!=1.4.5,!=1.4.6,>=1.1",
    "transaction >=1.6.0",
    "zope.interface >=3.6.0",
    "zope.testing ; extra == 'test'"
  ],
  "requires_python": ">=3.7",
  "summary": "minimal zope/sqlalchemy transaction integration",
  "version": "3.1",
  "releases": [],
  "developers": [
    "laurence@lrowe.co.uk",
    "laurence_rowe"
  ],
  "kwds": "sqlalchemy _sqlalchemy transaction_manager pyramid_tm wsgi",
  "license_kwds": "zpl 2.1",
  "libtype": "pypi",
  "id": "pypi_zope.sqlalchemy",
  "homepage": "https://github.com/zopefoundation/zope.sqlalchemy",
  "release_count": 25,
  "dependency_ids": [
    "pypi_packaging",
    "pypi_setuptools",
    "pypi_sqlalchemy",
    "pypi_transaction",
    "pypi_zope.interface",
    "pypi_zope.testing"
  ]
}