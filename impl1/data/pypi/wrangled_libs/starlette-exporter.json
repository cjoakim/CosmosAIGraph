{
  "classifiers": [],
  "description": "# starlette_exporter\n\n## prometheus exporter for starlette and fastapi\n\nstarlette_exporter collects basic metrics for starlette and fastapi based applications:\n\n* starlette_requests_total: a counter representing the total requests\n* starlette_request_duration_seconds: a histogram representing the distribution of request response times\n* starlette_requests_in_progress: a gauge that keeps track of how many concurrent requests are being processed\n\nmetrics include labels for the http method, the path, and the response status code.\n\n```\nstarlette_requests_total{method=\"get\",path=\"/\",status_code=\"200\"} 1.0\nstarlette_request_duration_seconds_bucket{le=\"0.01\",method=\"get\",path=\"/\",status_code=\"200\"} 1.0\n```\n\nuse the http handler `handle_metrics` at path `/metrics` to expose a metrics endpoint to prometheus.\n\n## table of contents\n\n* [starlette_exporter](#starlette_exporter)\n  * [prometheus exporter for starlette and fastapi](#prometheus-exporter-for-starlette-and-fastapi)\n  * [table of contents](#table-of-contents)\n  * [usage](#usage)\n    * [starlette](#starlette)\n    * [fastapi](#fastapi)\n  * [options](#options)\n  * [labels](#labels)\n  * [exemplars](#exemplars)\n  * [custom metrics](#custom-metrics)\n  * [multiprocess mode (gunicorn deployments)](#multiprocess-mode-gunicorn-deployments)\n  * [developing](#developing)\n  * [license](#license)\n  * [dependencies](#dependencies)\n  * [credits](#credits)\n\n## usage\n\n```sh\npip install starlette_exporter\n```\n\n### starlette\n\n```python\nfrom starlette.applications import starlette\nfrom starlette_exporter import prometheusmiddleware, handle_metrics\n\napp = starlette()\napp.add_middleware(prometheusmiddleware)\napp.add_route(\"/metrics\", handle_metrics)\n\n...\n```\n\n### fastapi\n\n```python\nfrom fastapi import fastapi\nfrom starlette_exporter import prometheusmiddleware, handle_metrics\n\napp = fastapi()\napp.add_middleware(prometheusmiddleware)\napp.add_route(\"/metrics\", handle_metrics)\n\n...\n```\n\n## options\n\n`app_name`: sets the value of the `app_name` label for exported metrics (default: `starlette`).\n\n`prefix`: sets the prefix of the exported metric names (default: `starlette`).\n\n`labels`: optional dict containing default labels that will be added to all metrics. the values can be either a static value or a callback function that\nretrieves a value from the `request` object. [see below](#labels) for examples.\n\n`exemplars`: optional dict containing label/value pairs. the \"value\" should be a callback function that returns the desired value at runtime.\n\n`group_paths`: setting this to `true` will populate the path label using named parameters (if any) in the router path, e.g. `/api/v1/items/{item_id}`. this will group requests together by endpoint (regardless of the value of `item_id`). this option may come with a performance hit for larger routers. default is `false`, which will result in separate metrics for different urls (e.g., `/api/v1/items/42`, `/api/v1/items/43`, etc.).\n\n`filter_unhandled_paths`: setting this to `true` will cause the middleware to ignore requests with unhandled paths (in other words, 404 errors). this helps prevent filling up the metrics with 404 errors and/or intentially bad requests. default is `false`.\n\n`buckets`: accepts an optional list of numbers to use as histogram buckets. the default value is `none`, which will cause the library to fall back on the prometheus defaults (currently `[0.01, 0.025, 0.05, 0.075, 0.1, 0.25, 0.5, 0.75, 1.0, 2.5, 5.0, 7.5, 10.0]`).\n\n`skip_paths`: accepts an optional list of paths that will not collect metrics. the default value is `none`, which will cause the library to collect metrics on every requested path. this option is useful to avoid collecting metrics on health check, readiness or liveness probe endpoints.\n\n`skip_methods`: accepts an optional list of methods that will not collect metrics. the default value is `none`, which will cause the library to collect request metrics with each method. this option is useful to avoid collecting metrics on requests related to the communication description for endpoints.\n\n`always_use_int_status`: accepts a boolean. the default value is false. if set to true the libary will attempt to convert the `status_code` value to an integer (e.g. if you are using httpstatus, httpstatus.ok will become 200 for all metrics).\n\n`optional_metrics`: a list of pre-defined metrics that can be optionally added to the default metrics. the following optional metrics are available:\n\n* `response_body_size`: a counter that tracks the size of response bodies for each endpoint\n\nfor optional metric examples, [see below](#optional-metrics).\n\nfull example:\n\n```python\napp.add_middleware(\n  prometheusmiddleware,\n  app_name=\"hello_world\",\n  prefix='myapp',\n  labels={\n      \"server_name\": os.getenv(\"hostname\"),\n  }),\n  group_paths=true,\n  buckets=[0.1, 0.25, 0.5],\n  skip_paths=['/health'],\n  skip_methods=['options'],\n  always_use_int_status=false),\n  exemplars=lambda: {\"trace_id\": get_trace_id}  # function that returns a trace id\n```\n\n## labels\n\nthe included metrics have built-in default labels such as `app_name`, `method`, `path`, and `status_code`. additional default labels can be\nadded by passing a dictionary to the `labels` arg to `prometheusmiddleware`. each label's value can be either a static\nvalue or, optionally, a callback function. the built-in default label names are reserved and cannot be reused.\n\nif a callback function is used, it will receive the request instance as its argument.\n\n```python\napp.add_middleware(\n  prometheusmiddleware,\n  labels={\n     \"service\": \"api\",\n     \"env\": os.getenv(\"env\")\n    }\n```\n\nensure that label names follow [prometheus naming conventions](https://prometheus.io/docs/practices/naming/) and that label\nvalues are constrained (see [this writeup from grafana on cardinality](https://grafana.com/blog/2022/02/15/what-are-cardinality-spikes-and-why-do-they-matter/)).\n\n### label helpers\n\n**`from_header(key: string, allowed_values: optional[iterable])`**: a convenience function for using a header value as a label.\n\n`allowed_values` allows you to supply a list of allowed values. if supplied, header values not in the list will result in\nan empty string being returned. this allows you to constrain the label values, reducing the risk of excessive cardinality.\n\ndo not use headers that could contain unconstrained values (e.g. user id) or user-supplied values.\n\n```python\nfrom starlette_exporter import prometheusmiddleware, from_header\n\napp.add_middleware(\n  prometheusmiddleware,\n  labels={\n      \"host\": from_header(\"x-internal-org\", allowed_values=(\"accounting\", \"marketing\", \"product\"))\n    }\n```\n\n## exemplars\n\nexemplars are used for labeling histogram observations or counter increments with a trace id. this allows adding\ntrace ids to your charts (for example, latency graphs could include traces corresponding to various latency buckets).\n\nto add exemplars to `starlette_exporter` metrics, pass a dict to the prometheusmiddleware class with label as well as\na callback function that returns a string (typically the current trace id).\n\n**example:**\n\n```python\n# must use `handle_openmetrics` instead of `handle_metrics` for exemplars to appear in /metrics output.\nfrom starlette_exporter import prometheusmiddleware, handle_openmetrics\n\napp.add_middleware(\n  prometheusmiddleware,\n  exemplars=lambda: {\"trace_id\": get_trace_id}  # supply your own callback function\n)\n\napp.add_route(\"/metrics\", handle_openmetrics)\n```\n\nexemplars are only supported by the openmetrics-text exposition format. a new `handle_openmetrics` handler function is provided\n(see above example).\n\nfor more information, see the [grafana exemplar documentation](https://grafana.com/docs/grafana/latest/fundamentals/exemplars/).\n\n## optional metrics\n\noptional metrics are pre-defined metrics that can be added to the default metrics.\n\n* `response_body_size`: the size of response bodies returned, in bytes\n* `request_body_size`: the size of request bodies received, in bytes\n\n**example**:\n\n```python\nfrom fastapi import fastapi\nfrom starlette_exporter import prometheusmiddleware, handle_metrics\nfrom starlette_exporter.optional_metrics import response_body_size, request_body_size\n\napp = fastapi()\napp.add_middleware(prometheusmiddleware, optional_metrics=[response_body_size, request_body_size])\n```\n\n## custom metrics\n\nstarlette_exporter will export all the prometheus metrics from the process, so custom metrics can be created by using the prometheus_client api.\n\n**example**:\n\n```python\nfrom prometheus_client import counter\nfrom starlette.responses import redirectresponse\n\nredirect_count = counter(\"redirect_total\", \"count of redirects\", [\"redirected_from\"])\n\nasync def some_view(request):\n    redirect_count.labels(\"some_view\").inc()\n    return redirectresponse(url=\"https://example.com\", status_code=302)\n```\n\nthe new metric will now be included in the the `/metrics` endpoint output:\n\n```\n...\nredirect_total{redirected_from=\"some_view\"} 2.0\n...\n```\n\n## multiprocess mode (gunicorn deployments)\n\nrunning starlette_exporter in a multiprocess deployment (e.g. with gunicorn) will need the `prometheus_multiproc_dir` env variable set, as well as extra gunicorn config.\n\nfor more information, see the [prometheus python client documentation](https://github.com/prometheus/client_python#multiprocess-mode-eg-gunicorn).\n\n## developing\n\nthis package supports python 3.6+.\n\n```sh\ngit clone https://github.com/stephenhillier/starlette_exporter\ncd starlette_exporter\npytest tests\n```\n\n## license\n\ncode released under the [apache license, version 2.0](./license).\n\n## dependencies\n\nhttps://github.com/prometheus/client_python (>= 0.12)\n\nhttps://github.com/encode/starlette\n\n## credits\n\nstarlette - https://github.com/encode/starlette\n\nfastapi - https://github.com/tiangolo/fastapi\n\nflask exporter - https://github.com/rycus86/prometheus_flask_exporter\n\nalternate starlette exporter - https://github.com/perdy/starlette-prometheus\n",
  "docs_url": null,
  "keywords": "",
  "license": "apache license 2.0",
  "name": "starlette-exporter",
  "package_url": "https://pypi.org/project/starlette-exporter/",
  "project_url": "https://pypi.org/project/starlette-exporter/",
  "project_urls": {
    "Homepage": "https://github.com/stephenhillier/starlette_exporter"
  },
  "release_url": "https://pypi.org/project/starlette-exporter/0.17.1/",
  "requires_dist": [
    "prometheus-client >=0.12",
    "starlette"
  ],
  "requires_python": "",
  "summary": "prometheus metrics exporter for starlette applications.",
  "version": "0.17.1",
  "releases": [],
  "developers": [
    "stephen_hillier",
    "stephenhillier@gmail.com"
  ],
  "kwds": "starlette_request_duration_seconds_bucket starlette_requests_in_progress starlette_request_duration_seconds starlette_requests_total handle_metrics",
  "license_kwds": "apache license 2.0",
  "libtype": "pypi",
  "id": "pypi_starlette_exporter",
  "homepage": "https://github.com/stephenhillier/starlette_exporter",
  "release_count": 22,
  "dependency_ids": [
    "pypi_prometheus_client",
    "pypi_starlette"
  ]
}