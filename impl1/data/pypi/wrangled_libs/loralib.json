{
  "classifiers": [
    "license :: osi approved :: mit license",
    "operating system :: os independent",
    "programming language :: python :: 3"
  ],
  "description": "# lora: low-rank adaptation of large language models\n*(for the radio communication technique, see [lora](https://lora-alliance.org/).)*\n\nthis repo contains the source code of the python package `loralib` and several examples of how to integrate it with pytorch models, such as those in hugging face.\nwe only support pytorch for now.\nsee our paper for a detailed description of lora.\n\n**lora: low-rank adaptation of large language models** <br>\n*edward j. hu\\*, yelong shen\\*, phillip wallis, zeyuan allen-zhu, yuanzhi li, shean wang, lu wang, weizhu chen* <br>\npaper: https://arxiv.org/abs/2106.09685 <br>\n\n*update 2/2023: lora is now supported by the [state-of-the-art parameter-efficient fine-tuning (peft)](https://github.com/huggingface/peft) library by hugging face.*\n\nlora reduces the number of trainable parameters by learning pairs of rank-decompostion matrices while freezing the original weights.\nthis vastly reduces the storage requirement for large language models adapted to specific tasks and enables efficient task-switching during deployment all without introducing inference latency.\nlora also outperforms several other adaptation methods including adapter, prefix-tuning, and fine-tuning.\n\nwe obtain result comparable or superior to full finetuning on the glue benchmark using [roberta (liu et al., 2019)](https://arxiv.org/abs/1907.11692) base and large and [deberta (he et al., 2020)](https://arxiv.org/abs/2006.03654) xxl 1.5b, while only training and storing a fraction of the parameters. click the numbers below to download the roberta and deberta lora checkpoints.\n\n|   |         | roberta base <br> fine-tune  |  roberta base <br> lora  | deberta xxl <br> fine-tune | deberta xxl <br> lora  |\n|---|-------------------------|----------------|--------------------------|-----------------|-----------------|\n|   | # of trainable params.  | 125m | 0.8m | 1.5b | 4.7m     |\n|   | mnli (m-acc/mm-acc)     | <b>87.6</b> | [<b>87.5</b>\u00b1.3/86.9\u00b1.3](https://github.com/microsoft/lora/releases/download/roberta-base/roberta_base_lora_mnli.bin) |91.7/<b>91.9</b>| [<b>91.9</b>\u00b1.1/<b>91.9</b>\u00b1.2](https://github.com/microsoft/lora/releases/download/deberta/deberta_v2_xxlarge_lora_mnli.bin)       |\n|   | sst2 (acc)              | 94.8 | [<b>95.1</b>\u00b1.2](https://github.com/microsoft/lora/releases/download/roberta-base/roberta_base_lora_sst2.bin) | <b>97.2</b>    | [96.9\u00b1.2](https://github.com/microsoft/lora/releases/download/deberta/deberta_v2_xxlarge_lora_sst2.bin)                    |\n|   | mrpc (acc)              | <b>90.2</b> | [<b>89.7</b>\u00b1.7](https://github.com/microsoft/lora/releases/download/roberta-base/roberta_base_lora_mrpc.bin) | 92.0           | [<b>92.6</b>\u00b1.6](https://github.com/microsoft/lora/releases/download/deberta/deberta_v2_xxlarge_lora_mrpc.bin)             |\n|   | cola (matthew's corr)   | <b>63.6</b> | [<b>63.4</b>\u00b11.2](https://github.com/microsoft/lora/releases/download/roberta-base/roberta_base_lora_cola.bin) | <b>72.0</b>    | [<b>72.4</b>\u00b11.1](https://github.com/microsoft/lora/releases/download/deberta/deberta_v2_xxlarge_lora_cola.bin)           |\n|   | qnli (acc)              | 92.8 | [<b>93.3</b>\u00b1.3](https://github.com/microsoft/lora/releases/download/roberta-base/roberta_base_lora_qnli.bin) | <b>96.0</b>    | [<b>96.0</b>\u00b1.1](https://github.com/microsoft/lora/releases/download/deberta/deberta_v2_xxlarge_lora_qnli.bin)            |\n|   | qqp (acc)               | <b>91.9</b> | [90.8\u00b1.1](https://github.com/microsoft/lora/releases/download/roberta-base/roberta_base_lora_qqp.bin) | 92.7           | [<b>92.9</b>\u00b1.1](https://github.com/microsoft/lora/releases/download/deberta/deberta_v2_xxlarge_lora_qqp.bin)           |\n|   | rte (acc)               | 78.7 | [<b>86.6</b>\u00b1.7](https://github.com/microsoft/lora/releases/download/roberta-base/roberta_base_lora_rte.bin) | 93.9           | [<b>94.9</b>\u00b1.4](https://github.com/microsoft/lora/releases/download/deberta/deberta_v2_xxlarge_lora_rte.bin)           |\n|   | stsb (pearson/spearman corr) | 91.2 | [<b>91.5</b>\u00b1.2/<b>91.3</b>\u00b1.2](https://github.com/microsoft/lora/releases/download/roberta-base/roberta_base_lora_stsb.bin) |<b>92.9</b>/92.6| [<b>93.0</b>\u00b1.2/<b>92.9</b>\u00b1.3](https://github.com/microsoft/lora/releases/download/deberta/deberta_v2_xxlarge_lora_stsb.bin)      |\n|   | average  | 86.40 | <b>87.24</b> | 91.06 | <b>91.32</b> |\n\n<i>note: you still need the original pre-trained checkpoint from [hugging face](https://huggingface.co/) to use the lora checkpoints.</i>\n\nfine-tuning numbers are taken from [liu et al. (2019)](https://arxiv.org/abs/1907.11692) and [he et al. (2020)](https://arxiv.org/abs/2006.03654).  we include confidence intervals on results from our experiments. please follow the instructions in `examples/nlu/` to reproduce our results.\n\non gpt-2, lora compares favorably to both full finetuning and other efficient tuning methods, such as [adapter (houlsby et al., 2019)](https://arxiv.org/abs/1902.00751) and [prefix tuning (li and liang, 2021)](https://arxiv.org/abs/2101.00190). we evaluated on e2e nlg challenge, dart, and webnlg:\n\n|   | method              | # of trainable params | e2e (bleu)   | dart (bleu)  | webnlg (bleu-u/s/a)            |\n|---|---------------------|-----------------------|--------------|--------------|--------------------------------|\n|   | gpt-2 m (fine-tune) | 354.92m               | 68.2         | 46.0         | 30.4/<b>63.2</b>/47.6          |\n|   | gpt-2 m (adapter)   | 0.37m                 | 66.3         | 42.4         | 45.1/54.5/50.2                 |\n|   | gpt-2 m (prefix)    | 0.35m                 | 69.7         | 45.7         | 44.1/63.1/54.4                 |\n|   | gpt-2 m (lora)      | 0.35m                 |<b>70.4</b>\u00b1.1|<b>47.1</b>\u00b1.2| <b>46.7</b>\u00b1.4/62.1\u00b1.2/<b>55.3</b>\u00b1.2 |\n|   | gpt-2 l (fine-tune) | 774.03m               | 68.5         | 46.5         | 41.7/<b>64.6</b>/54.2          |\n|   | gpt-2 l (adapter)   | 0.88m                 | 69.1\u00b1.1      | 45.7\u00b1.1      | <b>49.8</b>\u00b1.0/61.1\u00b1.0/56.0\u00b1.0 |\n|   | gpt-2 l (prefix)    | 0.77m                 | 70.3         | 46.5         | 47.0/64.2/56.4                 |\n|   | gpt-2 l (lora)      | 0.77m                 |<b>70.4</b>\u00b1.1|<b>47.5</b>\u00b1.1| 48.4\u00b1.3/<b>64.0</b>\u00b1.3/<b>57.0</b>\u00b1.1 |\n\nnon-lora baselines, except for adapter on gpt-2 large, are taken from [li and liang (2021)](https://arxiv.org/abs/2101.00190). we include confidence intervals on results from our experiments.\n\ndownload the gpt-2 lora checkpoints:\n * [gpt-2 medium e2e](https://github.com/microsoft/lora/releases/download/gpt-2/gpt2_md_lora_e2e.pt) (1.5 mb)\n * [gpt-2 medium dart](https://github.com/microsoft/lora/releases/download/gpt-2/gpt2_md_lora_dart.pt) (1.5 mb)\n * [gpt-2 medium webnlg](https://github.com/microsoft/lora/releases/download/gpt-2/gpt2_md_lora_webnlg.pt) (1.5 mb)\n * [gpt-2 large e2e](https://github.com/microsoft/lora/releases/download/gpt-2/gpt2_lg_lora_e2e.pt) (2.3 mb)\n * [gpt-2 large dart](https://github.com/microsoft/lora/releases/download/gpt-2/gpt2_lg_lora_dart.pt) (2.3 mb)\n * [gpt-2 large webnlg](https://github.com/microsoft/lora/releases/download/gpt-2/gpt2_lg_lora_webnlg.pt) (2.3 mb)\n\nplease follow the instructions in `examples/nlg/` to reproduce our result.\n## repository overview\n\n<i>(the initial release of this repo has been archived in the branch \"snapshot-9-15-2021\")</i>\n\nthere are several directories in this repo:\n* [loralib/](loralib) contains the source code for the package `loralib`, which needs to be installed to run the examples we provide;\n* [examples/nlg/](examples/nlg) contains an example implementation of lora in gpt-2 using our package, which can be used to reproduce the result in our paper;\n* [examples/nlu/](examples/nlu) contains an example implementation of lora in roberta and deberta using our package, which produces competitive results on the glue benchmark;\n* see how we use `loralib` in [gpt-2](examples/nlg/src/model.py), [roberta](examples/nlu/src/transformers/models/roberta/modeling_roberta.py), and [deberta v2](examples/nlu/src/transformers/models/deberta_v2/modeling_deberta_v2.py)\n\n## quickstart\n\n 1. installing `loralib` is simply\n ```bash\n pip install loralib\n # alternatively\n # pip install git+https://github.com/microsoft/lora\n ```\n\n 2. you can choose to adapt some layers by replacing them with counterparts implemented in `loralib`. we only support `nn.linear`, `nn.embedding`, and `nn.conv2d` for now. we also support a `mergedlinear` for cases where a single `nn.linear` represents more than one layers, such as in some implementations of the attention `qkv` projection (see additional notes for more).\n ```python\n # ===== before =====\n # layer = nn.linear(in_features, out_features)\n\n # ===== after ======\n import loralib as lora\n # add a pair of low-rank adaptation matrices with rank r=16\n layer = lora.linear(in_features, out_features, r=16)\n ```\n\n 3. before the training loop begins, mark only lora parameters as trainable.\n ```python\n import loralib as lora\n model = bigmodel()\n # this sets requires_grad to false for all parameters without the string \"lora_\" in their names\n lora.mark_only_lora_as_trainable(model)\n # training loop\n for batch in dataloader:\n    ...\n ```\n 4. when saving a checkpoint, generate a `state_dict` that only contains lora parameters.\n ```python\n # ===== before =====\n # torch.save(model.state_dict(), checkpoint_path)\n # ===== after =====\n torch.save(lora.lora_state_dict(model), checkpoint_path)\n ```\n 5. when loading a checkpoint using `load_state_dict`, be sure to set `strict=false`.\n ```python\n # load the pretrained checkpoint first\n model.load_state_dict(torch.load('ckpt_pretrained.pt'), strict=false)\n # then load the lora checkpoint\n model.load_state_dict(torch.load('ckpt_lora.pt'), strict=false)\n ```\n\n#### now training can proceed as usual.\n\n## additional notes\n\n1. while we focus on a simple yet effect setup, namely adapting only the `q` and `v` projection in a transformer, in our examples, lora can be apply to any subsets of pre-trained weights. we encourage you to explore different configurations, such as adapting the embedding layer by replacing `nn.embedding` with `lora.embedding` and/or adapting the mlp layers. it's very likely that the optimal configuration varies for different model architectures and tasks.\n\n2. some transformer implementation uses a single `nn.linear` for the projection matrices for query, key, and value. if one wishes to constrain the rank of the updates to the individual matrices, one has to either break it up into three separate matrices or use `lora.mergedlinear`. make sure to modify the checkpoint accordingly if you choose to break up the layer.\n```python\n# ===== before =====\n# qkv_proj = nn.linear(d_model, 3*d_model)\n# ===== after =====\n# break it up (remember to modify the pretrained checkpoint accordingly)\nq_proj = lora.linear(d_model, d_model, r=8)\nk_proj = nn.linear(d_model, d_model)\nv_proj = lora.linear(d_model, d_model, r=8)\n# alternatively, use lora.mergedlinear (recommended)\nqkv_proj = lora.mergedlinear(d_model, 3*d_model, r=8, enable_lora=[true, false, true])\n```\n3. training bias vectors in tandem with lora might be a cost-efficient way to squeeze out extra task performance (if you tune the learning rate carefully). while we did not study its effect thoroughly in our paper, we make it easy to try in `lora`. you can mark some biases as trainable by passing \"all\" or \"lora_only\" to `bias=` when calling `mark_only_lora_as_trainable`. remember to pass the corresponding `bias=` argument to `lora_state_dict` when saving a checkpoint.\n```python\n# ===== before =====\n# lora.mark_only_lora_as_trainable(model) # not training any bias vectors\n# ===== after =====\n# training all bias vectors associated with modules we apply lora to \nlora.mark_only_lora_as_trainable(model, bias='lora_only')\n# alternatively, we can train *all* bias vectors in the model, including layernorm biases\nlora.mark_only_lora_as_trainable(model, bias='all')\n# when saving a checkpoint, use the same bias= ('all' or 'lora_only')\ntorch.save(lora.lora_state_dict(model, bias='all'), checkpoint_path)\n```\n4. calling `model.eval()` will trigger the merging of lora parameters with the corresponding pretrained ones, which eliminates additional latency for subsequent forward passes. calling `model.train()` again will undo the merge. this can be disabled by passing `merge_weights=false` to lora layers.\n\n## contact\nplease contact us or post an issue if you have any questions.\n\nfor questions related to the package `loralib`:\n* edward hu (edward@edwardjhu.com)\n* phillip wallis (phwallis@microsoft.com)\n* weizhu chen (wzchen@microsoft.com)\n\nthe gpt-2 example:\n* phillip wallis (phwallis@microsoft.com)\n* yelong shen (yeshe@microsoft.com)\n\nthe roberta/deberta example:\n* lu wang (luw@microsoft.com)\n\n## acknowledgements\nwe thank in alphabetical order jianfeng gao, jade huang, jiayuan huang, lisa xiang li, xiaodong liu, yabin liu, benjamin van durme, luis vargas, haoran wei, peter welinder, and greg yang for providing valuable feedback.\n\n## citation\n```bibtex\n@inproceedings{\nhu2022lora,\ntitle={lo{ra}: low-rank adaptation of large language models},\nauthor={edward j hu and yelong shen and phillip wallis and zeyuan allen-zhu and yuanzhi li and shean wang and lu wang and weizhu chen},\nbooktitle={international conference on learning representations},\nyear={2022},\nurl={https://openreview.net/forum?id=nzevkeefyf9}\n}\n```\n\n## contributing\n\nthis project welcomes contributions and suggestions.  most contributions require you to agree to a\ncontributor license agreement (cla) declaring that you have the right to, and actually do, grant us\nthe rights to use your contribution. for details, visit https://cla.opensource.microsoft.com.\n\nwhen you submit a pull request, a cla bot will automatically determine whether you need to provide\na cla and decorate the pr appropriately (e.g., status check, comment). simply follow the instructions\nprovided by the bot. you will only need to do this once across all repos using our cla.\n\nthis project has adopted the [microsoft open source code of conduct](https://opensource.microsoft.com/codeofconduct/).\nfor more information see the [code of conduct faq](https://opensource.microsoft.com/codeofconduct/faq/) or\ncontact [opencode@microsoft.com](mailto:opencode@microsoft.com) with any additional questions or comments.\n",
  "docs_url": null,
  "keywords": "",
  "license": "",
  "name": "loralib",
  "package_url": "https://pypi.org/project/loralib/",
  "project_url": "https://pypi.org/project/loralib/",
  "project_urls": {
    "Homepage": "https://github.com/microsoft/LoRA"
  },
  "release_url": "https://pypi.org/project/loralib/0.1.2/",
  "requires_dist": [],
  "requires_python": ">=3.6",
  "summary": "pytorch implementation of low-rank adaptation (lora), a parameter-efficient approach to adapt a large pre-trained deep learning model which obtains performance on-par with full fine-tuning.",
  "version": "0.1.2",
  "releases": [],
  "developers": [
    "edward.hu@microsoft.com",
    "edward_j"
  ],
  "kwds": "pytorch lora_state_dict mark_only_lora_as_trainable lora_only lora",
  "license_kwds": "",
  "libtype": "pypi",
  "id": "pypi_loralib",
  "homepage": "https://github.com/microsoft/lora",
  "release_count": 3,
  "dependency_ids": []
}