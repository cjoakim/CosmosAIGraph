{
  "classifiers": [
    "development status :: 4 - beta",
    "license :: osi approved :: mit license",
    "programming language :: python :: 3",
    "programming language :: python :: 3.10",
    "programming language :: python :: 3.6",
    "programming language :: python :: 3.7",
    "programming language :: python :: 3.8",
    "programming language :: python :: 3.9"
  ],
  "description": "# pypsrp - python powershell remoting protocol client library\n\n[![test workflow](https://github.com/jborean93/pypsrp/actions/workflows/ci.yml/badge.svg)](https://github.com/jborean93/pypsrp/actions/workflows/ci.yml)\n[![codecov](https://codecov.io/gh/jborean93/pypsrp/branch/master/graph/badge.svg)](https://codecov.io/gh/jborean93/pypsrp)\n[![pypi version](https://badge.fury.io/py/pypsrp.svg)](https://badge.fury.io/py/pypsrp)\n\npypsrp is a python client for the powershell remoting protocol (psrp) and\nwindows remote management (winrm) service. it allows your to execute commands\non a remote windows host from any machine that can run python.\n\nthis library exposes 4 different types of apis;\n\n* a simple client api that can copy files to and from the remote windows host as well as execute processes and powershell scripts\n* a wsman interface to execute various wsman calls like `send`, `create`, `connect`, `disconnect`, etc\n* a windows remote shell (winrs) layer that executes cmd commands and executables using the base winrm protocol\n* a powershell remoting protocol (psrp) layer allows you to create remote runspace pools and powershell pipelines\n\nat a basic level, you can use this library to;\n\n* execute a cmd command\n* run another executable\n* execute powershell scripts\n* copy a file from the localhost to the remote windows host\n* fetch a file from the remote windows host to the localhost\n* create a runspace pool that contains one or multiple powershell pipelines and execute them asynchronously\n* support for a reference host base implementation of psrp for interactive scripts\n\ncurrently this library only supports the wsman transport method but is designed\nto support ssh at some point in the future (pr's are welcome). by default it\nsupports the following authentication methods with wsman;\n\n* basic\n* certificate\n* ntlm\n\nit also supports `negotiate/kerberos`, and `credssp` but require extra\nlibraries to be installed.\n\n\n## requirements\n\nsee `how to install` for more details\n\n* cpython 3.6+\n* [cryptography](https://github.com/pyca/cryptography)\n* [pyspnego](https://github.com/jborean93/pyspnego)\n* [requests](https://github.com/requests/requests)\n\n### optional requirements\n\nthe following python libraries can be installed to add extra features that do\nnot come with the base package:\n\n* [python-gssapi](https://github.com/pythongssapi/python-gssapi) for kerberos authentication on linux\n* [pykrb5](https://github.com/jborean93/pykrb5) for kerberos authentication on linux\n* [requests-credssp](https://github.com/jborean93/requests-credssp) for credssp authentication\n\n\n## how to install\n\nto install pypsrp with all the basic features, run:\n\n```bash\npip install pypsrp\n```\n\n### kerberos authentication\n\nwhile pypsrp supports kerberos authentication, it isn't included by default for\nlinux hosts due to it's reliance on system packages to be present.\n\nto install these packages, depending on your distribution, run one of the following script blocks.\n\nfor debian/ubuntu\n\n```bash\n# for python 2\napt-get install gcc python-dev libkrb5-dev\n\n# for python 3\napt-get install gcc python3-dev libkrb5-dev\n\n# to add ntlm to the gssapi spnego auth run\napt-get install gss-ntlmssp\n```\n\nfor rhel/centos\n\n```bash\nyum install gcc python-devel krb5-devel\n\n# to add ntlm to the gssapi spnego auth run\nyum install gssntlmssp\n```\n\nfor fedora\n\n```bash\ndnf install gcc python-devel krb5-devel\n\n# to add ntlm to the gssapi spnego auth run\ndnf install gssntlmssp\n```\n\nfor arch linux\n\n```bash\npacman -s gcc krb5\n```\n\nonce installed you can install the python packages with\n\n```bash\npip install pypsrp[kerberos]\n```\n\nkerberos also needs to be configured to talk to the domain but that is outside\nthe scope of this page.\n\n### credssp authentication\n\nlike kerberos auth, credssp is supported but isn't included by default. to add\nsupport for credssp auth try to run the following\n\n```bash\npip install pypsrp[credssp]\n```\n\nif that fails you may need to update pip and setuptools to a newer version\n`pip install -u pip setuptools`.\n\n\n## how to use\n\nthere are 3 main components that are in use within this library;\n\n* `transport`: handles the raw transport of messages to and from the server\n* `shell`: handles the wsmv or psrp protocol details used to create the remote shell that processes are run on, uses `connection` to send the details\n* `process`: runs the process or script within a shell\n\n### connection\n\ncurrently only the connection that is supported is the wsman protocol over http\nthrough `pypsrp.wsman.wsman` and offers mostly all the same features in the\nwsmv spec including;\n\n* basic, certificate, negotiate, kerberos, and credssp authentication\n* tls encryption\n* message encryption with negotiate, kerberos, and credssp authentication\n* definable proxy\n\nthese are the options that can be used to setup `wsman`;\n\n* `server`: the hostname or ip address of the host to connect to\n* `max_envelope_size`: the maximum envelope size, in bytes, that can be sent to the server, default is `153600`\n* `operation_timeout`: the operation timeout, in seconds, of each wsman operation, default is `20`. this should always be lower than `read_timeout`.\n* `port`: the port to connect to, default is `5986` if `ssl=true` else `5985`\n* `username`: the username to connect with, required for all auths except `certificate` and optionally required for `negotiate/kerberos`\n* `password`: the password for `username`. due to a bug on macos/heimdal gssapi implementations, this will persist in the user's ccache when using negotiate or kerberos authentication, run `kdestroy` manually to remove this\n* `ssl`: whether to connect over `https` or `https`, default is `true`\n* `path`: the winrm path to connect to, default is `wsman`\n* `auth`: the authentication protocol to use, default is `negotiate`, choices are `basic`, `certificate`, `negotiate`, `ntlm`, `kerberos`, `credssp`\n* `cert_validation`: whether to validate the server's ssl certificate, default is `true`. can be `false` to not validate or a path to a pem file of trusted certificates\n* `connection_timeout`: the timeout for creating a http connection, default is `30`\n* `read_timeout`: the timeout for receiving a response from the server after a request has been made, default is `30`\n* `encryption`: controls the encryption settings, default is `auto`, choices are `auto`, `always`, `never`. set to `always` to always run message encryption even over https, `never` to never use message encryption even over http\n* `proxy`: the proxy url used to connect to the remote host\n* `no_proxy`: whether to ignore any environment proxy variable and connect directly to the host, default is `false`\n* `locale`: the `wsmv:locale` value to set on each wsman request. this specifies the language in which the cleint wants response text to be translated, default is `en-us`\n* `data_locale`: the `wsmv:datalocale` value to set on each wsman request. this specifies the format in which numerical data is presented in the response text, default is the value of `locale`\n* `reconnection_retries`: number of retries on a connection problem, default is `0`\n* `reconnection_backoff`: number of seconds to backoff in between reconnection attempts (first sleeps x, then sleeps 2*x, 4*x, 8*x, ...), default is `2.0`\n* `certificate_key_pem`: the path to the certificate key used in `certificate` authentication\n* `certificate_pem`: the path to the certificate used in `certificate` authentication\n* `credssp_auth_mechanism`: the sub-auth mechanism used in credssp, default is `auto`, choices are `auto`, `ntlm`, or `kerberos`\n* `credssp_disable_tlsv1_2`: whether to used credssp auth over the insecure tlsv1.0, default is `false`\n* `credssp_minimum_version`: the minimum credssp server version that the client will connect to, default is `2`\n* `negotiate_delegate`: whether to negotiate the credential to the host, default is `false`. this is only valid if `negotiate` auth negotiated kerberos or `kerberos` was explicitly set\n* `negotiate_hostname_override`: the hostname used to calculate the host spn when authenticating the host with kerberos auth. this is only valid if `negotiate` auth negotiated kerberos or `kerberos` was explicitly set\n* `negotiate_send_cbt`: whether to binding the channel binding token (https only) to the auth or ignore, default is `true`\n* `negotiate_service`: override the service part of the calculated spn used when authenticating the server, default is `wsman`. this is only valid if `negotiate` auth negotiated kerberos or `kerberos` was explicitly set\n\nwhen running over http, this library will enforce encryption by default but if\nthat is not supported (basic auth) or isn't available on the host then either\nuse https or disable encryption with `encryption=\"never\"`.\n\nthere are plans to add support for ssh as a connection but this still needs to\nbe implemented. ssh will work on hosts that are running powershell core but\nnot the standard powershell.\n\n### shell\n\nthere are two shells that can be used in this library, `pypsrp.shell.winrs` and\n`pypsrp.powershell.runspacepool`.\n\n`winrs` is a cmd shell that can be used to issue cmd commands, including but\nnot limited to other executables. here are the options that can be used to\nconfigure a `winrs` shell;\n\n* `wsman`: winrs only works over wsman, so this is the `pypsrp.wsman.wsman` object to run the commands over\n* `resource_uri`: the resource uri of the shell, defaults to `http://schemas.microsoft.com/wbem/wsman/1/windows/shell/cmd`\n* `id`: the id if the shell, this should be kept as `none` as it is created dynamically by the server\n* `input_streams`: the input stream(s) of the shell, default is `stdin`\n* `output_streams`: the output stream(s) of the shell, default is `stdout, stderr`\n* `codepage`: the codepage of the shell, default is the default of the host\n* `environment`: a dictionary of environment key/values to set for the remote shell\n* `idle_time_out`: the idle timeout in seconds of the shell\n* `lifetime`: the total lifetime of the shell\n* `name`: the name (description only) of the shell\n* `no_profile`: whether to create the shell with the user profile loaded or not\n* `working_directory`: the default working directory of the created shell\n\n`runspacepool` is a shell used by the psrp protocol, it is designed to be a\nclose implementation of the .net\n[system.management.automation.runspaces.runspacepool](https://docs.microsoft.com/en-us/dotnet/api/system.management.automation.runspaces.runspacepool?view=powershellsdk-1.1.0)\nclass. the methods and properties are similar and can mostly do the same thing.\nhere are the options that can be used to configure a `runspacepool` shell;\n\n* `connection`: the connection object used by the runspacepool to send commands to the remote server, currently only supports `wsman`\n* `apartment_state`: the int value of `pypsrp.complex_objects.apartmentstate` for the remote thread, default is `unknown`\n* `thread_options`: the int value of `pypsrp.complex_objects.threadoptions` that specifies the type of thread to create, default is `default`\n* `host`: the local host info implementation, default is no host\n* `configuration_name`: the configuration name to connect to, default is `microsoft.powershell` and can be used to specify the just enough administration (jea) to connect to\n* `min_runspaces`: the minimuum number of runspaces that a pool can hold, default is 1\n* `max_runspaces`: the maximum number of runspaces that a pool can hold. each powershell pipeline is run in a single runspace, default is 1\n* `session_key_timeout_ms`: the maximum time to wait for a session key transfer from the server\n\n### process\n\nthere are two process objects that can be used, `pypsrp.shell.process` for the\n`winrs` shell and `pypsrp.powershell.powershell` for the `runspacepool` shell.\nthese objects are ultimately used to execute commands, processes, or scripts on\nthe remote host.\n\n`process` is used with the `winrs` shell to execute a cmd command or another\nexecutable. the following options are used to configure the `process` object;\n\n* `shell`: the `winrs` shell the process is run over\n* `executable`: the executable or command to run\n* `arguments`: a list of arguments to the executable or command, default is no arguments\n* `id`: the id of the created command, if not specified then this is dynamically created\n* `no_shell`: whether to create a command in the cmd shell or bypass it, default is `false`. if `true` then the executable must be the full path to the exe. this only works on older os' before 2012 r2 (not including)\n\nto execute the process, call `.invoke()`, the `stdout`, `stderr`, and `rc`\nproperties contain the output of the command once complete.\n\n`powershell` is used by the psrp protocol, it is designed to be a close\nimplementation of the\n[system.management.automation.powershell](https://docs.microsoft.com/en-us/dotnet/api/system.management.automation.powershell?view=powershellsdk-1.1.0)\nclass. the methods and properties are similar and can mostly do the same thing.\nhere are the options that can be used to configure a `powershell` process;\n\n* `runspace_pool`: the `runspacepool` object to run the `powershell` process on\n\nto execute the process, call `.invoke()`, the `output`, `had_erros`, and\n`streams` contains the execution status and output information of the process.\nbefore invoke can be called, cmdlets or scripts must be added. these can be\ndone with the following methods;\n\n* `add_script`: add a raw powershell script to the pending commands\n* `add_cmdlet`: add a cmdlet to the pending commands\n* `add_parameters`: add a dictionary of key/value parameters to the last added command\n* `add_argument`: add a value argument to the last added command\n* `add_statement`: set the last command/script to be the end of that pipeline so the next command/script is like a newline\n\nsee the examples below for more details.\n\n### examples\n\nhow to use the high level client api\n\n```python\nfrom pypsrp.client import client\n\n# this takes in the same kwargs as the wsman object\nwith client(\"server\", username=\"user\", password=\"password\") as client:\n\n    # execute a cmd command\n    stdout, stderr, rc = client.execute_cmd(\"dir\")\n\n    stdout, stderr, rc = client.execute_cmd(\"powershell.exe gci $pwd\")\n    sanitised_stderr = client.sanitise_clixml(stderr)\n\n    # execute a powershell script\n    output, streams, had_errors = client.execute_ps('''$path = \"%s\"\nif (test-path -path $path) {\n    remove-item -path $path -force -recurse\n}\nnew-item -path $path -itemtype directory''' % path)\n    output, streams, had_errors = client.execute_ps(\"new-item -path c:\\\\temp\\\\folder -itemtype directory\")\n\n    # copy a file from the local host to the remote host\n    client.copy(\"~/file.txt\", \"c:\\\\temp\\\\file.txt\")\n\n    # fetch a file from the remote host to the local host\n    client.fetch(\"c:\\\\temp\\\\file.txt\", \"~/file.txt\")\n```\n\nhow to use winrs/process to execute a command\n\n\n```python\nfrom pypsrp.shell import process, signalcode, winrs\nfrom pypsrp.wsman import wsman\n\n# creates a http connection with no encryption and basic auth\nwsman = wsman(\"server\", ssl=false, auth=\"basic\", encryption=\"never\",\n              username=\"vagrant\", password=\"vagrant\")\n\nwith wsman, winrs(wsman) as shell:\n    process = process(shell, \"dir\")\n    process.invoke()\n    process.signal(signalcode.ctrl_c)\n\n    # execute a process with arguments in the background\n    process = process(shell, \"powershell\", [\"gci\", \"$pwd\"])\n    process.begin_invoke()  # start the invocation and return immediately\n    process.poll_invoke()  # update the output stream\n    process.end_invoke()  # finally wait until the process is finished\n    process.signal(signalcode.ctrl_c)\n```\n\nhow to use runspacepool/powershell to execute a powershell script/command\n\n```python\nfrom pypsrp.powershell import powershell, runspacepool\nfrom pypsrp.wsman import wsman\n\n# creates a https connection with explicit kerberos auth and implicit credentials\nwsman = wsman(\"server\", auth=\"kerberos\", cert_validation=false))\n\nwith wsman, runspacepool(wsman) as pool:\n    # execute 'get-process | select-object name'\n    ps = powershell(pool)\n    ps.add_cmdlet(\"get-process\").add_cmdlet(\"select-object\").add_argument(\"name\")\n    output = ps.invoke()\n\n    # execute 'get-process | select-object -property name'\n    ps.add_cmdlet(\"get-process\").add_cmdlet(\"select-object\")\n    ps.add_parameter(\"property\", \"name\")\n    ps.begin_invoke()  # execute process in the background\n    ps.poll_invoke()  # update the output streams\n    ps.end_invoke()  # wait until the process is finished\n\n    # execute 'get-process | select-object -property name; get-service audiosrv'\n    ps.add_cmdlet(\"get-process\").add_cmdlet(\"select-object\").add_parameter(\"property\", \"name\")\n    ps.add_statement()\n    ps.add_cmdlet(\"get-service\").add_argument(\"audiosrc\")\n    ps.invoke()\n\n    # execute a powershell script with input being sent\n    script = '''begin {\n    $debugpreference = \"continue\"\n    write-debug -message \"begin\"\n} process {\n    write-output -inputobject $input\n} end {\n    write-debug -message \"end\"\n}\n'''\n    ps.add_script(script)\n    ps.invoke([\"string\", 1])\n    print(ps.output)\n    print(ps.streams.debug)\n```\n\n\n## logging\n\nthis library takes advantage of the python logging configuration and messages\nare logged to the `pypsrp` named logger as well as `pypsrp.*` where `*` is each\npython script in the `pypsrp` directory.\n\nan easy way to turn on logging for the entire library is to create the\nfollowing json file and run your script with\n`pypsrp_log_cfg=log.json python script.py` (this does not work with python\n2.6).\n\n```json\n{\n    \"version\": 1,\n    \"disable_existing_loggers\": false,\n    \"formatters\": {\n        \"simple\": {\n            \"format\": \"%(asctime)s - %(name)s - %(levelname)s - %(message)s\"\n        }\n    },\n\n    \"handlers\": {\n        \"console\": {\n            \"class\": \"logging.streamhandler\",\n            \"level\": \"debug\",\n            \"formatter\": \"simple\",\n            \"stream\": \"ext://sys.stdout\"\n        }\n    },\n\n    \"loggers\": {\n        \"pypsrp\": {\n            \"level\": \"debug\",\n            \"handlers\": [\"console\"],\n            \"propagate\": \"no\"\n        }\n    }\n}\n```\n\nyou can adjust the log level by changing the level value in `logger` to `info`.\n\n_note: `debug` contains a lot of information and will output all the messages\nsent to and from the client. this can have the side effect of leaking sensitive\ninformation and should only be used for debugging purposes._\n\n\n## testing\n\nany changes are more than welcome in pull request form, you can run the current\ntest suite with tox like so;\n\n```bash\n# make sure tox is installed\npip install tox\n\n# run the tox suite\ntox\n\n# or run the test manually for the current python environment\npy.test -v --pep8 --cov pypsrp --cov-report term-missing\n```\n\na lot of the tests either simulate a remote windows host but you can also run a\nlot of them against a real windows host. to do this, set the following\nenvironment variables before running the tests;\n\n* `pypsrp_server`: the hostname or ip of the remote host\n* `pypsrp_username`: the username to connect with\n* `pypsrp_password`: the password to connect with\n* `pypsrr_port`: the port to connect with (default: `5986`)\n* `pypsrp_auth`: the authentication protocol to auth with (default: `negotiate`)\n\nthere are further integration tests that require a specific host setup to run\ncorrectly. you can use `vagrant` to set this host up. this is done by running\nthe following commands;\n\n```bash\n# download the vagrant box and start it up based on the vagrantfile\nvagrant up\n\n# once the above script is complete run the following\nvagrant ssh  # password is vagrant\n\npowershell.exe\nregister-pssessionconfiguration -path \"c:\\users\\vagrant\\documents\\jearolesettings.pssc\" -name jearole -force\n\n$sec_pass = convertto-securestring -string \"vagrant\" -asplaintext -force\n$credential = new-object -typename system.management.automation.pscredential -argumentlist \"vagrant\", $sec_pass\n$thumbprint = (get-childitem -path cert:\\localmachine\\trustedpeople)[0].thumbprint\n\nnew-item -path wsman:\\localhost\\clientcertificate `\n    -subject \"vagrant@localhost\" `\n    -uri * `\n    -issuer $thumbprint `\n    -credential $credential `\n    -force\n\n\n# exit the remote powershell session\nexit\n\n# exist the ssh session\nexit\n```\n\nonce complete, set the following environment variables to run the integration\ntests;\n\n* `pypsrp_run_integration`: to any value\n* `pypsrp_server`: set to `127.0.0.1`\n* `pypsrp_username`: set to `vagrant`\n* `pypsrp_password`: set to `vagrant`\n* `pypsrp_http_port`: set to `55985`\n* `pypsrp_https_port`: set to `55986`\n* `pypsrp_cert_dir`: set to the full path of the project directory\n\nfrom here you can run the normal test suite and it will run all the integration\ntests.\n\n\n## backlog\n\n* look at implementing the following transport options\n    * named pipes\n    * ssh\n* update ci to use named pipes for integration tests\n* add ansible playbook for better integration tests\n* improved serialization between python and .net objects\n* live interactive console for psrp\n\n\n",
  "docs_url": null,
  "keywords": "winrm,psrp,winrs,windows,powershell",
  "license": "mit",
  "name": "pypsrp",
  "package_url": "https://pypi.org/project/pypsrp/",
  "project_url": "https://pypi.org/project/pypsrp/",
  "project_urls": {
    "Homepage": "https://github.com/jborean93/pypsrp"
  },
  "release_url": "https://pypi.org/project/pypsrp/0.8.1/",
  "requires_dist": [
    "cryptography",
    "pyspnego (<1.0.0)",
    "requests (>=2.9.1)",
    "requests-credssp (>=2.0.0) ; extra == 'credssp'",
    "pyspnego[kerberos] ; extra == 'kerberos'"
  ],
  "requires_python": "",
  "summary": "powershell remoting protocol and winrm for python",
  "version": "0.8.1",
  "releases": [],
  "developers": [
    "jborean93@gmail.com",
    "jordan_borean"
  ],
  "kwds": "pypsrp_server pypsrp_run_integration pypsrp pypsrr_port winrm",
  "license_kwds": "mit",
  "libtype": "pypi",
  "id": "pypi_pypsrp",
  "homepage": "https://github.com/jborean93/pypsrp",
  "release_count": 14,
  "dependency_ids": [
    "pypi_cryptography",
    "pypi_pyspnego",
    "pypi_requests",
    "pypi_requests_credssp"
  ]
}