{
  "classifiers": [
    "development status :: 4 - beta",
    "framework :: django",
    "framework :: django :: 3.2",
    "framework :: django :: 4.0",
    "framework :: django :: 4.1",
    "intended audience :: developers",
    "license :: osi approved :: mit license",
    "operating system :: os independent",
    "programming language :: python :: 3",
    "programming language :: python :: 3.10",
    "programming language :: python :: 3.11",
    "programming language :: python :: 3.8",
    "programming language :: python :: 3.9",
    "topic :: internet :: www/http",
    "topic :: internet :: www/http :: dynamic content",
    "topic :: software development :: libraries :: python modules"
  ],
  "description": "# django-test-migrations\n\n[![wemake.services](https://img.shields.io/badge/%20-wemake.services-green.svg?label=%20&logo=data%3aimage%2fpng%3bbase64%2civborw0kggoaaaansuheugaaabaaaaaqcamaaaaolq9taaaabgdbtueaalgpc%2fxhbqaaaafzukdcak7ohokaaaabuexurqaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaap%2f%2f%2f5tvxdiaaaaidfjouwajra8xxanal%2bv0saaaadnjrefugnnjycaiojjrbdbfwmkvqegzchawksjnappzgogaaszpzaehegvslexqwe7yswcb7afzsf3bbaaaaabjru5erkjggg%3d%3d)](https://wemake-services.github.io)\n[![build status](https://github.com/wemake-services/django-test-migrations/workflows/test/badge.svg?branch=master&event=push)](https://github.com/wemake-services/django-test-migrations/actions?query=workflow%3atest)\n[![codecov](https://codecov.io/gh/wemake-services/django-test-migrations/branch/master/graph/badge.svg)](https://codecov.io/gh/wemake-services/django-test-migrations)\n[![python version](https://img.shields.io/pypi/pyversions/django-test-migrations.svg)](https://pypi.org/project/django-test-migrations/)\n![pypi - django version](https://img.shields.io/pypi/djversions/django-test-migrations)\n[![wemake-python-styleguide](https://img.shields.io/badge/style-wemake-000000.svg)](https://github.com/wemake-services/wemake-python-styleguide)\n\n\n## features\n\n- allows to test `django` schema and data migrations\n- allows to test both forward and rollback migrations\n- allows to test the migrations order\n- allows to test migration names\n- allows to test database configuration\n- fully typed with annotations and checked with `mypy`, [pep561 compatible](https://www.python.org/dev/peps/pep-0561/)\n- easy to start: has lots of docs, tests, and tutorials\n\nread the [announcing post](https://sobolevn.me/2019/10/testing-django-migrations).\nsee real-world [usage example](https://github.com/wemake-services/wemake-django-template).\n\n\n## installation\n\n```bash\npip install django-test-migrations\n```\n\nwe support several `django` versions:\n\n- `2.2`\n- `3.2`\n- `4.0`\n- `4.1`\n- `4.2`\n\nother versions most likely will work too,\nbut they are not officially supported.\n\n\n## testing django migrations\n\ntesting migrations is not a frequent thing in `django` land.\nbut, sometimes it is totally required. when?\n\nwhen we do complex schema or data changes\nand what to be sure that existing data won't be corrupted.\nwe might also want to be sure that all migrations can be safely rolled back.\nand as a final touch, we want to be sure that migrations\nare in the correct order and have correct dependencies.\n\n### testing forward migrations\n\nto test all migrations we have a [`migrator`](https://github.com/wemake-services/django-test-migrations/blob/master/django_test_migrations/migrator.py) class.\n\nit has three methods to work with:\n\n- `.apply_initial_migration()` which takes app and migration names to generate\n  a state before the actual migration happens. it creates the `before state`\n  by applying all migrations up to and including the ones passed as an argument.\n\n- `.apply_tested_migration()` which takes app and migration names to perform the\n  actual migration\n\n- `.reset()` to clean everything up after we are done with testing\n\nso, here's an example:\n\n```python\nfrom django_test_migrations.migrator import migrator\n\nmigrator = migrator(database='default')\n\n# initial migration, currently our model has only a single string field:\n# note:\n# we are testing migration `0002_someitem_is_clean`, so we are specifying\n# the name of the previous migration (`0001_initial`) in the\n# .apply_initial_migration() method in order to prepare a state of the database\n# before applying the migration we are going to test.\n#\nold_state = migrator.apply_initial_migration(('main_app', '0001_initial'))\nsomeitem = old_state.apps.get_model('main_app', 'someitem')\n\n# let's create a model with just a single field specified:\nsomeitem.objects.create(string_field='a')\nassert len(someitem._meta.get_fields()) == 2  # id + string_field\n\n# now this migration will add `is_clean` field to the model:\nnew_state = migrator.apply_tested_migration(\n    ('main_app', '0002_someitem_is_clean'),\n)\nsomeitem = new_state.apps.get_model('main_app', 'someitem')\n\n# we can now test how our migration worked, new field is there:\nassert someitem.objects.filter(is_clean=true).count() == 0\nassert len(someitem._meta.get_fields()) == 3  # id + string_field + is_clean\n\n# cleanup:\nmigrator.reset()\n```\n\nthat was an example of a forward migration.\n\n### backward migration\n\nthe thing is that you can also test backward migrations.\nnothing really changes except migration names that you pass and your logic:\n\n```python\nmigrator = migrator()\n\n# currently our model has two field, but we need a rollback:\nold_state = migrator.apply_initial_migration(\n    ('main_app', '0002_someitem_is_clean'),\n)\nsomeitem = old_state.apps.get_model('main_app', 'someitem')\n\n# create some data to illustrate your cases:\n# ...\n\n# now this migration will drop `is_clean` field:\nnew_state = migrator.apply_tested_migration(('main_app', '0001_initial'))\n\n# assert the results:\n# ...\n\n# cleanup:\nmigrator.reset()\n```\n\n### testing migrations ordering\n\nsometimes we also want to be sure that our migrations are in the correct order\nand that all our `dependencies = [...]` are correct.\n\nto achieve that we have [`plan.py`](https://github.com/wemake-services/django-test-migrations/blob/master/django_test_migrations/plan.py) module.\n\nthat's how it can be used:\n\n```python\nfrom django_test_migrations.plan import all_migrations, nodes_to_tuples\n\nmain_migrations = all_migrations('default', ['main_app', 'other_app'])\nassert nodes_to_tuples(main_migrations) == [\n    ('main_app', '0001_initial'),\n    ('main_app', '0002_someitem_is_clean'),\n    ('other_app', '0001_initial'),\n    ('main_app', '0003_update_is_clean'),\n    ('main_app', '0004_auto_20191119_2125'),\n    ('other_app', '0002_auto_20191120_2230'),\n]\n```\n\nthis way you can be sure that migrations\nand apps that depend on each other will be executed in the correct order.\n\n### `factory_boy` integration\n\nif you use factories to create models, you can replace their respective\n`.build()` or `.create()` calls with methods of `factory` and pass the\nmodel name and factory class as arguments:\n\n```python\nimport factory\n\nold_state = migrator.apply_initial_migration(\n    ('main_app', '0002_someitem_is_clean'),\n)\nsomeitem = old_state.apps.get_model('main_app', 'someitem')\n\n# instead of\n# item = someitemfactory.create()\n# use this:\nfactory.create(someitem, factory_class=someitemfactory)\n\n# ...\n```\n\n\n## test framework integrations \ud83d\udc0d\n\nwe support several test frameworks as first-class citizens.\nthat's a testing tool after all!\n\nnote that the django `post_migrate` signal's receiver list is cleared at\nthe start of tests and restored afterwards. if you need to test your\nown `post_migrate` signals then attach/remove them during a test.\n\n### pytest\n\nwe ship `django-test-migrations` with a `pytest` plugin\nthat provides two convenient fixtures:\n\n- `migrator_factory` that gives you an opportunity\n  to create `migrator` classes for any database\n- `migrator` instance for the `'default'` database\n\nthat's how it can be used:\n\n```python\nimport pytest\n\n@pytest.mark.django_db()\ndef test_pytest_plugin_initial(migrator):\n    \"\"\"ensures that the initial migration works.\"\"\"\n    old_state = migrator.apply_initial_migration(('main_app', none))\n\n    with pytest.raises(lookuperror):\n        # model does not yet exist:\n        old_state.apps.get_model('main_app', 'someitem')\n\n    new_state = migrator.apply_tested_migration(('main_app', '0001_initial'))\n    # after the initial migration is done, we can use the model state:\n    someitem = new_state.apps.get_model('main_app', 'someitem')\n    assert someitem.objects.filter(string_field='').count() == 0\n```\n\n### unittest\n\nwe also ship an integration with the built-in `unittest` framework.\n\nhere's how it can be used:\n\n```python\nfrom django_test_migrations.contrib.unittest_case import migratortestcase\n\nclass testdirectmigration(migratortestcase):\n    \"\"\"this class is used to test direct migrations.\"\"\"\n\n    migrate_from = ('main_app', '0002_someitem_is_clean')\n    migrate_to = ('main_app', '0003_update_is_clean')\n\n    def prepare(self):\n        \"\"\"prepare some data before the migration.\"\"\"\n        someitem = self.old_state.apps.get_model('main_app', 'someitem')\n        someitem.objects.create(string_field='a')\n        someitem.objects.create(string_field='a b')\n\n    def test_migration_main0003(self):\n        \"\"\"run the test itself.\"\"\"\n        someitem = self.new_state.apps.get_model('main_app', 'someitem')\n\n        assert someitem.objects.count() == 2\n        assert someitem.objects.filter(is_clean=true).count() == 1\n```\n\n### choosing only migrations tests\n\nin ci systems it is important to get instant feedback. running tests that\napply database migration can slow down tests execution, so it is often a good\nidea to run standard, fast, regular unit tests without migrations in parallel\nwith slower migrations tests.\n\n#### pytest\n\n`django_test_migrations` adds `migration_test` marker to each test using\n`migrator_factory` or `migrator` fixture.\nto run only migrations test, use `-m` option:\n\n```bash\npytest -m migration_test  # runs only migration tests\npytest -m \"not migration_test\"  # runs all except migration tests\n```\n\n#### unittest\n\n`django_test_migrations` adds `migration_test`\n[tag](https://docs.djangoproject.com/en/3.0/topics/testing/tools/#tagging-tests)\nto every `migratortestcase` subclass.\nto run only migrations tests, use `--tag` option:\n\n```bash\npython mange.py test --tag=migration_test  # runs only migration tests\npython mange.py test --exclude-tag=migration_test  # runs all except migration tests\n```\n\n\n## django checks\n\n`django_test_migrations` comes with 2 groups of django's checks for:\n\n+ detecting migrations scripts automatically generated names\n+ validating some subset of database settings\n\n### testing migration names\n\n`django` generates migration names for you when you run `makemigrations`.\nthese names are bad ([read more](https://adamj.eu/tech/2020/02/24/how-to-disallow-auto-named-django-migrations/) about why it is bad)!\njust look at this: `0004_auto_20191119_2125.py`\n\nwhat does this migration do? what changes does it have?\n\none can also pass `--name` attribute when creating migrations, but it is easy to forget.\n\nwe offer an automated solution: `django` check\nthat produces an error for each badly named migration.\n\nadd our check into your `installed_apps`:\n\n```python\ninstalled_apps = [\n    # ...\n\n    # our custom check:\n    'django_test_migrations.contrib.django_checks.autonames',\n]\n```\n\nthen in your ci run:\n\n```bash\npython manage.py check --deploy\n```\n\nthis way you will be safe from wrong names in your migrations.\n\ndo you have a migrations that cannot be renamed? add them to the ignore list:\n\n```python\n# settings.py\n\ndtm_ignored_migrations = {\n    ('main_app', '0004_auto_20191119_2125'),\n    ('dependency_app', '0001_auto_20201110_2100'),\n}\n```\n\nthen we won't complain about them.\n\nor you can completely ignore entire app:\n\n```python\n# settings.py\n\ndtm_ignored_migrations = {\n    ('dependency_app', '*'),\n    ('another_dependency_app', '*'),\n}\n```\n\n### database configuration\n\nadd our check to `installed_apps`:\n\n```python\ninstalled_apps = [\n    # ...\n\n    # our custom check:\n    'django_test_migrations.contrib.django_checks.databaseconfiguration',\n]\n```\n\nthen just run `check` management command in your ci like listed in section\nabove.\n\n\n## related projects\n\nyou might also like:\n\n- [django-migration-linter](https://github.com/3yourmind/django-migration-linter) - detect backward incompatible migrations for your django project.\n- [wemake-django-template](https://github.com/wemake-services/wemake-django-template/) - bleeding edge django template focused on code quality and security with both `django-test-migrations` and `django-migration-linter` on board.\n\n\n## credits\n\nthis project is based on work of other awesome people:\n\n- [@asfaltboy](https://gist.github.com/asfaltboy/b3e6f9b5d95af8ba2cc46f2ba6eae5e2)\n- [@blueyed](https://gist.github.com/blueyed/4fb0a807104551f103e6)\n- [@fernandogrd](https://gist.github.com/blueyed/4fb0a807104551f103e6#gistcomment-1546191)\n- [@adamchainz](https://adamj.eu/tech/2020/02/24/how-to-disallow-auto-named-django-migrations/)\n\n\n## license\n\nmit.\n",
  "docs_url": null,
  "keywords": "django,django-tests,django-migrations,django-orm,migrations,orm,sql,tests,test,pytest,pytest-plugin",
  "license": "mit",
  "name": "django-test-migrations",
  "package_url": "https://pypi.org/project/django-test-migrations/",
  "project_url": "https://pypi.org/project/django-test-migrations/",
  "project_urls": {
    "Homepage": "https://github.com/wemake-services/django-test-migrations",
    "Repository": "https://github.com/wemake-services/django-test-migrations"
  },
  "release_url": "https://pypi.org/project/django-test-migrations/1.3.0/",
  "requires_dist": [
    "typing_extensions (>=3.6,<5)"
  ],
  "requires_python": ">=3.8,<4.0",
  "summary": "test django schema and data migrations, including ordering",
  "version": "1.3.0",
  "releases": [],
  "developers": [
    "mail@sobolevn.me",
    "sobolevn"
  ],
  "kwds": "django_test_migrations django djangoproject test_migration_main0003 apply_tested_migration",
  "license_kwds": "mit",
  "libtype": "pypi",
  "id": "pypi_django_test_migrations",
  "homepage": "https://github.com/wemake-services/django-test-migrations",
  "release_count": 7,
  "dependency_ids": [
    "pypi_typing_extensions"
  ]
}