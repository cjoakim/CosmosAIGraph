{
  "classifiers": [
    "programming language :: python",
    "programming language :: python :: 3.10",
    "programming language :: python :: 3.8",
    "programming language :: python :: 3.9"
  ],
  "description": "# datadog apm test agent\n\n[![github workflow status (with branch)](https://img.shields.io/github/actions/workflow/status/datadog/dd-apm-test-agent/main.yml?style=flat-square)](https://github.com/datadog/dd-apm-test-agent/actions?query=workflow%3aci+branch%3amaster)\n[![pypi](https://img.shields.io/pypi/v/ddapm-test-agent?style=flat-square)](https://pypi.org/project/ddapm-test-agent/)\n\n\n<img align=\"right\" src=\"https://user-images.githubusercontent.com/6321485/136316621-b4af42b6-4d1f-4482-a45b-bdee47e94bb8.jpeg\" alt=\"bits agent\" width=\"200px\"/>\n\nthe apm test agent is an application which emulates the apm endpoints of the [datadog agent](https://github.com/datadog/datadog-agent/) which can be used for testing datadog apm client libraries.\n\nsee the [features](#features) section for the complete list of functionalities provided.\n\nsee the [http api](#http-api) section for the endpoints available.\n\nsee the [development](#development) section for how to get the test agent running locally to add additional checks or fix bugs.\n\n\n## installation\n\nthe test agent can be installed from pypi:\n\n    pip install ddapm-test-agent\n\n    ddapm-test-agent --port=8126\n\nor from docker:\n\n    # run the test agent and mount the snapshot directory\n    docker run --rm\\\n            -p 8126:8126\\\n            -e snapshot_ci=0\\\n            -v $pwd/tests/snapshots:/snapshots\\\n            ghcr.io/datadog/dd-apm-test-agent/ddapm-test-agent:latest\n\nor from source:\n\n    pip install git+https://github.com/datadog/dd-apm-test-agent\n\nor a specific branch:\n\n    pip install git+https://github.com/datadog/dd-apm-test-agent@{branch}\n\n\n## features\n\n### trace invariant checks\n\nmany checks are provided by the test agent which will verify trace data. \nall checks are enabled by default and can be manually disabled.\n\nsee the [configuration](#configuration) section for the options.\n\n| check description  | check name |\n| ------------- | ------------- |\n| trace count header matches number of traces  | `trace_count_header`  |\n| client library version header included in request  | `meta_tracer_version_header`  |\n| trace content length header matches payload size  | `trace_content_length`  |\n\n\n### returning data\n\nall data that is submitted to the test agent can be retrieved.\n\n- traces can be returned via the `/test/traces` endpoint documented [below](#api).\n\n\n### helpful logging\n\nthe `info` log level of the test agent outputs useful information about the requests the test agent receives. for traces this includes a visual representation of the traces.\n\n```\ninfo:ddapm_test_agent.agent:received trace payload with 1 trace chunk\ninfo:ddapm_test_agent.agent:chunk 0\n[parent]\n\u251c\u2500 [child1]\n\u251c\u2500 [child2]\n\u2514\u2500 [child3]\ninfo:ddapm_test_agent.agent:end of payload ----------------------------------------\n```\n\n\n### proxy\n\nthe test agent provides proxying to the datadog agent. \nthis is enabled by passing the agent url to the test agent either via the `--agent-url` command-line argument or by the `dd_trace_agent_url` or `dd_agent_url` environment variables.\n\nwhen proxying is enabled, the response from the datadog agent will be returned instead of one from the test agent.\n\nat the trace-level, proxying can also be disabled by including the `x-datadog-agent-proxy-disabled` header with a value of `true`. this will disable proxying after a trace \nis handled, regardless of whether an agent url is set.\n\n\n### snapshot testing\n\nthe test agent provides a form of [characterization testing](https://en.wikipedia.org/wiki/characterization_test) which\nwe refer to as snapshotting. \nthis allows library maintainers to ensure that traces don't change unexpectedly when making unrelated changes.\n\nthis can be used to write integration tests by having test cases use the tracer to emit traces which are collected by the test agent and compared against reference traces stored previously.\n\nto do snapshot testing with the test agent:\n\n1. ensure traces are associated with a session token (typically the name of the test case) by either:\n   - calling the `/test/session/start` with the token endpoint before emitting the traces; or\n   - attaching an additional query string parameter or header specifying the session token on `/vx.y/trace` requests (see below for\n     the api specifics). (required for concurrent test running)\n2. emit traces (run the integration test).\n3. signal the end of the session and perform the snapshot comparison by calling the `/tests/session/snapshot` endpoint\n   with the session token. the endpoint will return a `400` response code if the snapshot failed along with a plain-text\n   trace of the error which can be forwarded to the test framework to help triage the issue.\n\n\n#### snapshot output\n\nthe traces are normalized and output in json to a file. the following transformations are made to the input:\n\n- trace ids are overwritten to match the order in which the traces were received.\n- span ids are overwritten to be the dfs order of the spans in the trace tree.\n- parent ids are overwritten using the normalized span ids. however, if the parent is not a span in the trace, the parent id is not overwritten. this is necessary for handling distributed traces where all spans are not sent to the same agent.\n- span attributes are ordered to be more human-readable, with the important attributes being listed first.\n- span attributes are otherwise ordered alphanumerically.\n- the span meta and metrics maps if empty are excluded.\n\n\n## configuration\n\nthe test agent can be configured via command-line options or via environment variables.\n\n### command line\n\n#### ddapm-test-agent\n\n`ddapm-test-agent` is command used to run a test agent.\n\nplease refer to `ddapm-test-agent --help` for more information.\n\n#### ddapm-test-agent-fmt\n\n`ddapm-test-agent-fmt` is a command line tool to format or lint snapshot json files.\n\n``` bash\n# format all snapshot json files\nddapm-test-agent-fmt path/to/snapshots\n\n# lint snapshot json files\nddapm-test-agent-fmt --check path/to/snapshots\n```\n\nplease refer to `ddapm-test-agent-fmt --help` for more information.\n\n### environment variables\n\n- `port` [`8126`]: port to listen on.\n\n- `enabled_checks` [`\"\"`]: comma-separated values of checks to enable. valid values can be found in [trace invariant checks](#trace-invariant-checks)\n\n- `log_level` [`\"info\"`]: log level to use. debug, info, warning, error, critical.\n\n- `log_span_fmt` [`\"[{name}]\"`]: format string to use when outputting spans in logs.\n\n- `snapshot_dir` [`\"./snapshots\"`]: directory in which snapshots will be stored.\n  can be overridden by providing the `dir` query parameter on `/snapshot`.\n\n- `snapshot_ci` [`0`]: toggles ci mode for the snapshot tests. set to `1` to\n  enable. ci mode does the following:\n    - when snapshots are unexpectedly _generated_ from a test case a failure will\n      be raised.\n\n- `snapshot_ignored_attrs` [`\"span_id,trace_id,parent_id,duration,start,metrics.system.pid,metrics.process_id,metrics.system.process_id,meta.runtime-id\"`]: the\n  attributes to ignore when comparing spans in snapshots.\n\n- `dd_agent_url` [`\"\"`]: url to a datadog agent. when provided requests will be proxied to the agent.\n\n- `dd_apm_receiver_socket` [`\"\"`]: when provided, the test agent will listen for traces on a socket at the path provided (e.g., `/var/run/datadog/apm.socket`)\n\n- `dd_suppress_trace_parse_errors` [`false`]: set to `\"true\"` to disable span parse errors when decoding handled traces. when disabled, errors will not be thrown for\nmetrics incorrectly placed within the meta field, or other type errors related to span tag formatting/types. can also be set using the `--suppress-trace-parse-errors=true` option.\n\n- `snapshot_removed_attrs` [`\"\"`]: the attributes to remove from spans in snapshots. this is useful for removing attributes \nthat are not relevant to the test case. **note that removing `span_id` is not permitted to allow span \nordering to be maintained.**\n\n- `dd_pool_trace_check_failures` [`false`]: set to `\"true\"` to pool trace check failures that occured within test-agent memory. these failures can be queried later using the `/test/trace_check/failures` endpoint. can also be set using the `--pool-trace-check-failures=true` option.\n\n- `dd_disable_error_responses` [`false`]: set to `\"true\"` to disable test-agent `<response 400>` when a trace check fails, instead sending a valid `<response 200>`. recommended for use with the `dd_pool_trace_check_failures` env variable. can also be set using the `--disable-error-responses=true` option.\n\n\n## http api\n\n### /test/traces\n\nreturn traces that have been received by the agent. traces matching specific trace ids can be requested with the options\nbelow.\n\n#### [optional] `?trace_ids=`\n#### [optional] `x-datadog-trace-ids`\n\nspecify trace ids as comma separated values (eg. `12345,7890,2468`)\n\n\n### /test/session/start\n\ninitiate a _synchronous_ session. all subsequent traces received will be\nassociated with the required test token provided.\n\n#### [optional] `?agent_sample_rate_by_service=`\n\nsample rates to be returned by the agent in response to trace v0.4 and v0.5 requests.\n\nexample: `\"{'service:test,env:staging': 0.5, 'service:test2,env:prod': 0.2}\"` (note the json has to be url-encoded).\n\n#### [optional] `?test_session_token=`\n#### [optional] `x-datadog-test-session-token`\n\ntest session token for a test case. **ensure this value is unique to avoid conflicts between sessions.**\n\n\n### /test/session/snapshot\n\nperform a snapshot generation or comparison on the data received during the session.\n\nsnapshots are generated when the test agent is not in ci mode and there is no snapshot file present. otherwise a\nsnapshot comparison will be performed.\n\n\n#### [optional\\*] `?test_session_token=`\n#### [optional\\*] `x-datadog-test-session-token`\nto run test cases in parallel this http header must be specified. all test\ncases sharing a test token will be grouped.\n\n\\* required for concurrent tests. either via query param or http header.\n\n#### [optional] `?ignores=`\n\ncomma-separated list of keys of which to ignore values for.\n\nthe default built-in ignore list is: `span_id`, `trace_id`, `parent_id`,\n`duration`, `start`, `metrics.system.pid`, `metrics.process_id`,\n`metrics.system.process_id`, `meta.runtime-id`.\n\n\n#### [optional] `?dir=`\n\ndefault: `./snapshots` (relative to where the test agent is run).\n\noverride the directory where the snapshot will be stored and retrieved from.\n**this directory must already exist**.\n\nthis value will override the environment variable `snapshot_dir`.\n\nwarning: it is an error to specify both `dir` and `file`.\n\n#### [optional] `?file=`\n#### [optional] `x-datadog-test-snapshot-filename`\n\nan absolute or relative (to the current working directory of the agent) file\nname where the snap will be stored and retrieved.\n\nwarning: it is an error to specify both `file` and `dir`.\n\nnote: the file extension will be appended to the filename.\n\n`_tracestats` will be appended to the filename for trace stats requests.\n\n#### [optional] `?removes=`\n\ncomma-separated list of keys that will be removed from spans in the snapshot.\n\nthe default built-in remove list does not remove any keys.\n\n\n### /test/session/requests\n\nreturn all requests that have been received by the agent for the given session token.\n\n#### [optional] `?test_session_token=`\n#### [optional] `x-datadog-test-session-token`\n\nreturns the requests in the following json format:\n\n```json\n[\n  {\n    \"headers\": {},\n    \"body\": \"...\",\n    \"url\": \"http...\",\n    \"method\": \"get\"\n  }\n]\n```\n\n`body` is a base64 encoded body of the request.\n\n### /test/session/traces\n\nreturn traces that have been received by the agent for the given session token.\n\n#### [optional] `?test_session_token=`\n#### [optional] `x-datadog-test-session-token`\n\n\n### /test/session/stats\n\nreturn stats that have been received by the agent for the given session token.\n\n#### [optional] `?test_session_token=`\n#### [optional] `x-datadog-test-session-token`\n\nstats are returned as a json list of the stats payloads received.\n\n### /test/session/responses/config (post)\ncreate a remote config payload to retrieve in endpoint `/v0.7/config`\n\n#### [optional] `?test_session_token=`\n#### [optional] `x-datadog-test-session-token`\n\n```\ncurl -x post 'http://0.0.0.0:8126/test/session/responses/config/path' -d '{\"roots\": [\"eyj....fx0=\"], \"targets\": \"ey...19\", \"target_files\": [{\"path\": \"datadog/2/asm_data/blocked_users/config\", \"raw\": \"eyjydwxlc19kyxrhijogw119\"}], \"client_configs\": [\"datadog/2/asm_data/blocked_users/config\"]}'\n```\n\n### /test/session/responses/config/path (post)\ndue to remote config payload being quite complicated, this endpoint works like `/test/session/responses/config (post)` \nbut you should send a path and a message and this endpoint builds the remote config payload.\n\nthe keys of the json body are `path` and `msg`\n\n#### [optional] `?test_session_token=`\n#### [optional] `x-datadog-test-session-token`\n\n```\ncurl -x post 'http://0.0.0.0:8126/test/session/responses/config/path' -d '{\"path\": \"datadog/2/asm_data/blocked_users/config\", \"msg\": {\"rules_data\": []}}'\n```\n\n\n### /test/trace_check/failures (get)\nget trace check failures that occured. if a token is included, trace failures for only that session token are returned unless used in conjuction with `return_all`, which can be used to return all failures regardless of inputted token.  this method returns a `<response 200>` if no trace check failures are being returned and a `<response 400>` if trace check failures are being returned. trace check failures are returned as a content type of text, with failure messages concatenated in the response body. optionally, set the `use_json` query string parameter to `true` to return trace check failures as a json response in the following format: \n```\nresponse = { \n  \"<failing_check_name>\" : [\"<failure_message_1>\", \"<failure_message_2>\"]\n}\n```\n\nnote: to be used in combination with `dd_pool_trace_check_failures`, or else failures will not be saved within test-agent memory and a `<response 200>` will always be returned.\n\n#### [optional] `?test_session_token=`\n#### [optional] `x-datadog-test-session-token`\n#### [optional] `?use_json=`\n#### [optional] `?return_all=`\n\n```\ncurl -x get 'http://0.0.0.0:8126/test/trace_check/failures'\n```\n\n### /test/trace_check/clear (get)\nclear trace check failures that occured. if a token is included, trace failures for only that session token are cleared unless used in conjuction with `clear_all`. this argument can be used to clear all failures (regardless of inputted session token).\n\n#### [optional] `?test_session_token=`\n#### [optional] `x-datadog-test-session-token`\n#### [optional] `?clear_all=`\n\n```\ncurl -x get 'http://0.0.0.0:8126/test/trace_check/clear'\n```\n\n### /test/trace_check/summary (get)\nget trace check summary results. if a token is included, returns summary results only for trace checks run during the session.  the `return_all` optional query string parameter can be used to return all trace check results (regardless of inputted session token). the method returns trace check results in the following json format: \n```\nsummary = { \n  \"trace_content_length\" : {\n    \"passed_checks\": 10,\n    \"failed_checks\": 0,\n    \"skipped_checks\": 4,\n  }  ...\n}\n```\n\n#### [optional] `?test_session_token=`\n#### [optional] `x-datadog-test-session-token`\n#### [optional] `?return_all=`\n\n```\ncurl -x get 'http://0.0.0.0:8126/test/trace_check/summary'\n```\n\n### /test/session/integrations (put)\nupdate information about the current tested integration.\n\n#### [optional] `?test_session_token=`\n#### [optional] `x-datadog-test-session-token`\n\n```\ncurl -x put 'http://0.0.0.0:8126/test/session/integrations' -d '{\"integration_name\": [integration_name], \"integration_version\": [integration_version],\n\"dependency_name\": [dependency_name], \"tracer_language\": [tracer_language], \"tracer_version\": [tracer_version]}'\n```\n\n### /test/integrations/tested_versions (get)\nreturn a csv list of all tested integrations received by the agent. the format of returned data will be: \n`tracer_language,tracer_version,integration_name,integration_version,dependency_name`.\n\n#### [optional] `?test_session_token=`\n#### [optional] `x-datadog-test-session-token`\n\n```\ncurl -x get 'http://0.0.0.0:8126/test/integrations/tested_versions'\n```\n\n### /v0.1/pipeline_stats\n\nmimics the pipeline_stats endpoint of the agent, but always returns ok, and logs a line everytime it's called.\n\n### /tracer_flare/v1\n\nmimics the tracer_flare endpoint of the agent. returns ok if the flare contains the required form fields, otherwise `400`.\n\nlogs a line everytime it's called and stores the tracer flare details in the request under `\"_tracer_flare\"`.\n\n### /test/session/tracerflares\n\nreturn all tracer-flares that have been received by the agent for the given session token.\n\n#### [optional] `?test_session_token=`\n#### [optional] `x-datadog-test-session-token`\n\nreturns the tracer-flares in the following json format:\n\n```json\n[\n  {\n    \"source\": \"...\",\n    \"case_id\": \"...\",\n    \"email\": \"...\",\n    \"hostname\": \"...\",\n    \"flare_file\": \"...\",\n  }\n]\n```\n\n`flare_file` is the base64 encoded content of the tracer-flare payload.\n\nif there was an error parsing the tracer-flare form, that will be recorded under `error`.\n\n## development\n\n### prerequisites\n\na python version of 3.8 or above and [`riot`](https://github.com/datadog/riot) are required. it is recommended to create\nand work out of a virtualenv:\n\n    python3.11 -m venv .venv\n    source .venv/bin/activate\n    pip install -e '.[testing]'\n\n\n### running the tests\n\nto run the tests (in python 3.8):\n\n    riot run -p3.11 test\n\nnote: if snapshots need to be (re)generated in the tests set the environment variable `generate_snapshots=1`.\n\n    generate_snapshots=1 riot run --pass-env -p3.8 test -k test_trace_missing_received\n\n\n### linting and formatting\n\nto lint, format and type-check the code:\n\n    riot run -s flake8\n    riot run -s fmt\n    riot run -s mypy\n\n### docker\n\nto build (and tag) the dockerfile:\n\n```bash\ndocker build --tag testagent .\n```\n\nrun the tagged image:\n\n```bash\ndocker run --rm -v ${pwd}/snaps:/snapshots --publish 8126:8126 agent\n```\n\n\n### release notes\n\nthis project follows [`semver`](https://semver.org/) and so bug fixes, breaking\nchanges, new features, etc must be accompanied by a release note. to generate a\nrelease note:\n\n```bash\nriot run reno new <short-description-of-change>\n```\n\ndocument the changes in the generated file, remove the irrelevant sections and\ncommit the release note with the change.\n\n\n### releasing\n\n1. checkout the `master` branch and make sure it's up to date.\n```bash\n    git checkout master && git pull\n```\n2. generate the release notes and use [`pandoc`](https://pandoc.org/) to format\nthem for github:\n```bash\n    riot run -s reno report --no-show-source | pandoc -f rst -t gfm --wrap=none\n```\n   copy the output into a new release: https://github.com/datadog/dd-apm-test-agent/releases/new.\n\n2. enter a tag for the release (following [`semver`](https://semver.org)) (eg. `v1.1.3`, `v1.0.3`, `v1.2.0`).\n3. use the tag without the `v` as the title.\n4. save the release as a draft and pass the link to someone else to give a quick review.\n5. if all looks good hit publish\n",
  "docs_url": null,
  "keywords": "",
  "license": "bsd 3",
  "name": "ddapm-test-agent",
  "package_url": "https://pypi.org/project/ddapm-test-agent/",
  "project_url": "https://pypi.org/project/ddapm-test-agent/",
  "project_urls": {
    "Homepage": "https://github.com/Datadog/dd-apm-test-agent"
  },
  "release_url": "https://pypi.org/project/ddapm-test-agent/1.16.0/",
  "requires_dist": [
    "aiohttp",
    "ddsketch",
    "msgpack",
    "requests",
    "typing-extensions",
    "yarl",
    "ddtrace ==1.7.2 ; extra == 'testing'",
    "pytest ; extra == 'testing'",
    "riot ==0.13.0 ; extra == 'testing'"
  ],
  "requires_python": ">=3.8",
  "summary": "test agent for datadog apm client libraries",
  "version": "1.16.0",
  "releases": [],
  "developers": [
    "kyle@verhoog.ca",
    "kyle_verhoog"
  ],
  "kwds": "ddapm_test_agent dd_agent_url dd_trace_agent_url ddapm apm",
  "license_kwds": "bsd 3",
  "libtype": "pypi",
  "id": "pypi_ddapm_test_agent",
  "homepage": "https://github.com/datadog/dd-apm-test-agent",
  "release_count": 30,
  "dependency_ids": [
    "pypi_aiohttp",
    "pypi_ddsketch",
    "pypi_ddtrace",
    "pypi_msgpack",
    "pypi_pytest",
    "pypi_requests",
    "pypi_riot",
    "pypi_typing_extensions",
    "pypi_yarl"
  ]
}