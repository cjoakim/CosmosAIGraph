{
  "classifiers": [],
  "description": "# token merging for stable diffusion\n\nusing nothing but pure python and pytorch, tome for sd speeds up diffusion by merging _redundant_ tokens.\n\n![tome for sd applied on a 2048x2048 image.](https://raw.githubusercontent.com/dbolya/tomesd/main/examples/assets/teaser.jpg)\n\nthis is the official implementation of **tome for sd** from our short paper:  \n**[token merging for fast stable diffusion](https://arxiv.org/abs/2303.17604)**  \n[daniel bolya](https://dbolya.github.io), [judy hoffman](https://faculty.cc.gatech.edu/~judy/)  \n_[github](https://github.com/dbolya/tomesd)_ | _[arxiv](https://arxiv.org/abs/2303.17604)_ | _[bibtex](#citation)_\n\ntome for sd is an extension of the original **tome**:  \n**[token merging: your vit but faster](https://arxiv.org/abs/2210.09461)**  \n[daniel bolya](https://dbolya.github.io), \n[cheng-yang fu](http://www.cs.unc.edu/~cyfu/),\n[xiaoliang dai](https://sites.google.com/view/xiaoliangdai/),\n[peizhao zhang](https://research.facebook.com/people/zhang-peizhao/),\n[christoph feichtenhofer](https://feichtenhofer.github.io/),\n[judy hoffman](https://faculty.cc.gatech.edu/~judy/)  \n_[iclr '23 oral (top 5%)](https://openreview.net/forum?id=jrozrarw7eu)_ | _[github](https://github.com/facebookresearch/tome)_ | _[arxiv](https://arxiv.org/abs/2210.09461)_ | _[blog](https://research.facebook.com/blog/2023/2/token-merging-your-vit-but-faster/)_ | _[bibtex](https://github.com/facebookresearch/tome#citation)_\n\n**note:** this extension of tome is not affiliated in any way with meta.\n\n\n## what is tome for sd?\n![a diffusion block with tome applied and the resulting images at different merge ratios.](https://raw.githubusercontent.com/dbolya/tomesd/main/examples/assets/method.jpg)\n\ntoken merging (**tome**) speeds up transformers by _merging redundant tokens_, which means the transformer has to do _less work_. we apply this to the underlying transformer blocks in stable diffusion in a clever way that minimizes quality loss while keeping most of the speed-up and memory benefits. tome for sd _doesn't_ require training and should work out of the box for any stable diffusion model.\n\n**note:** this is a lossy process, so the image _will_ change, ideally not by much. here are results with [fid](https://github.com/mseitzer/pytorch-fid) scores vs. time and memory usage (lower is better) when using stable diffusion v1.5 to generate 512x512 images of imagenet-1k classes on a 4090 gpu with 50 plms steps using fp16:\n\n| method                      | r% | fid \u2193  | time (s/im) \u2193            | memory (gb/im) \u2193        |\n|-----------------------------|----|:------|:--------------------------|:------------------------|\n| baseline _(original model)_ | 0  | 33.12 | 3.09                      | 3.41                    |\n| w/ **tome for sd**        | 10 | 32.86 | 2.56 (**1.21x** _faster_) | 2.99 (**1.14x** _less_) |\n|                             | 20 | 32.86 | 2.29 (**1.35x** _faster_) | 2.17 (**1.57x** _less_) |\n|                             | 30 | 32.80 | 2.06 (**1.50x** _faster_) | 1.71 (**1.99x** _less_) |\n|                             | 40 | 32.87 | 1.85 (**1.67x** _faster_) | 1.26 (**2.71x** _less_) |\n|                             | 50 | 33.02 | 1.65 (**1.87x** _faster_) | 0.89 (**3.83x** _less_) |\n|                             | 60 | 33.37 | 1.52 (**2.03x** _faster_) | 0.60 (**5.68x** _less_) |\n\neven with more than half of the tokens merged (60%!), tome for sd still produces images close to the originals, while being _**2x** faster_ and using _**~5.7x** less memory_. moreover, tome is not another efficient reimplementation of transformer modules. instead, it actually _reduces_ the total work necessary to generate an image, so it can function _in conjunction_ with efficient implementations (see [usage](#tome--xformers--flash-attn--torch-20)).\n\n## news\n - **[2023.04.02]** tome for sd is now available via pip as [tomesd](https://pypi.org/project/tomesd/). thanks @mkshing!\n - **[2023.03.31]** tome for sd now supports [diffusers](https://github.com/huggingface/diffusers). thanks @junnyu and @exponentialml!\n - **[2023.03.30]** initial release.\n\nsee the [changelog](changelog.md) for more details.\n\n\n## supported environments\n\nthis repo includes code to patch an existing stable diffusion environment. currently, we support the following implementations:\n - [x] [stable diffusion v2](https://github.com/stability-ai/stablediffusion)\n - [x] [stable diffusion v1](https://github.com/runwayml/stable-diffusion)\n - [x] [latent diffusion](https://github.com/compvis/latent-diffusion)\n - [x] [diffusers](https://github.com/huggingface/diffusers)\n - [ ] and potentially others\n\n**note:** this also supports most downstream uis that use these repositories.\n\n\n## installation\n\ntome for sd requires ``pytorch >= 1.12.1`` (for `scatter_reduce`), which you can get from [here](https://pytorch.org/get-started/locally/). then after installing your choice of stable diffusion environment ([supported environments](#supported-environments)), use the corresponding python environment to install tome for sd:\n\n```bash\npip install tomesd\n```\n\n### installing from source\nif you'd like to install from source to get the latest updates, clone the repository:\n```bash\ngit clone https://github.com/dbolya/tomesd\ncd tomesd\n```\nthen set up the tomesd package with:\n```bash\npython setup.py build develop\n```\nthat's it! tome for sd is implemented in pure python, no cuda compilation required. \ud83d\ude42\n\n\n## usage\napply tome for sd to any stable diffusion model with\n```py\nimport tomesd\n\n# patch a stable diffusion model with tome for sd using a 50% merging ratio.\n# using the default options are recommended for the highest quality, tune ratio to suit your needs.\ntomesd.apply_patch(model, ratio=0.5)\n\n# however, if you want to tinker around with the settings, we expose several options.\n# see docstring and paper for details. note: you can patch the same model multiple times.\ntomesd.apply_patch(model, ratio=0.9, sx=4, sy=4, max_downsample=2) # extreme merging, expect diminishing returns\n```\nsee above for what speeds and memory savings you can expect with different ratios.\nif you want to remove the patch later, simply use `tomesd.remove_patch(model)`.\n\n### example\nto apply tome to the txt2img script of sdv2 or sdv1 for instance, add the following to [this line](https://github.com/stability-ai/stablediffusion/blob/fc1488421a2761937b9d54784194157882cbc3b1/scripts/txt2img.py#l220) (sdv2) or [this line](https://github.com/runwayml/stable-diffusion/blob/08ab4d326c96854026c4eb3454cd3b02109ee982/scripts/txt2img.py#l241) (sdv1):\n```py\nimport tomesd\ntomesd.apply_patch(model, ratio=0.5)\n```\nthat's it! more examples and demos coming soon (_hopefully_).  \n**note:** you may not see the full speed-up for the first image generated (as pytorch sets up the graph). since tome for sd uses random processes, you might need to set the seed every batch if you want consistent results.\n\n### diffusers\ntome can also be used to patch a \ud83e\udd17 diffusers stable diffusion pipeline:\n```py\nimport torch, tomesd\nfrom diffusers import stablediffusionpipeline\n\npipe = stablediffusionpipeline.from_pretrained(\"runwayml/stable-diffusion-v1-5\", torch_dtype=torch.float16).to(\"cuda\")\n\n# apply tome with a 50% merging ratio\ntomesd.apply_patch(pipe, ratio=0.5) # can also use pipe.unet in place of pipe here\n\nimage = pipe(\"a photo of an astronaut riding a horse on mars\").images[0]\nimage.save(\"astronaut.png\")\n```\nyou can remove the patch with `tomesd.remove_patch(pipe)`.\n\n### tome + xformers / flash attn / torch 2.0\nsince tome only affects the forward function of the block, it should support most efficient transformer implementations out of the box. just apply the patch as normal!\n\n**note:** when testing with xformers, i observed the most speed-up with tome when using _big_ images (i.e., 2048x2048 in the parrot example above). you can get even more speed-up with more aggressive merging configs, but quality obviously suffers. for the result above, i had each method img2img from the same 512x512 res image (i.e., i only applied tome during the second pass of \"high res fix\") and used the default config with 60% merging. also, the memory benefits didn't stack with xformers (efficient attention already takes care of memory concerns).\n\n\n## citation\n\nif you use tome for sd or this codebase in your work, please cite:\n```\n@article{bolya2023tomesd,\n  title={token merging for fast stable diffusion},\n  author={bolya, daniel and hoffman, judy},\n  journal={arxiv},\n  year={2023}\n}\n```\nif you use tome in general please cite the original work:\n```\n@inproceedings{bolya2023tome,\n  title={token merging: your {vit} but faster},\n  author={bolya, daniel and fu, cheng-yang and dai, xiaoliang and zhang, peizhao and feichtenhofer, christoph and hoffman, judy},\n  booktitle={international conference on learning representations},\n  year={2023}\n}\n```\n",
  "docs_url": null,
  "keywords": "",
  "license": "mit",
  "name": "tomesd",
  "package_url": "https://pypi.org/project/tomesd/",
  "project_url": "https://pypi.org/project/tomesd/",
  "project_urls": {
    "Homepage": "https://github.com/dbolya/tomesd"
  },
  "release_url": "https://pypi.org/project/tomesd/0.1.3/",
  "requires_dist": [
    "torch (>=1.12.1)"
  ],
  "requires_python": "",
  "summary": "token merging for stable diffusion",
  "version": "0.1.3",
  "releases": [],
  "developers": [
    "daniel_bolya"
  ],
  "kwds": "tokens token diffusion _merging tokens_",
  "license_kwds": "mit",
  "libtype": "pypi",
  "id": "pypi_tomesd",
  "homepage": "https://github.com/dbolya/tomesd",
  "release_count": 3,
  "dependency_ids": [
    "pypi_torch"
  ]
}